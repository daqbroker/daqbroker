<!DOCTYPE html>

<html>
 <head>
	
	<meta charset='utf-8'>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	{% include 'imports.html' %}
  <title>Runs</title>
 </head>
 <body>
<div class="thebody">
<div id="main">

<!--<div style="width:100%;display:table-row">
	<div class="icon" style="align:left;display:table-cell"><fieldset style="width:10%"><span style="font-size:130%">DAQBroker</span></fieldset></div>
	<div class="dbSelectorDiv" style="width:10%;display:table-cell;valign:center">
		<fieldset>
			Current DB: <select class="dbSelector"><option selected disabled>--- CHOOSE ONE ---</option></select>
		</fieldset>
	</div>
</div>

<hr style="width:65%">-->

<div class="headerMenu" style="background-color:#333;width:100%;display:table">
	<div style="width:50%;display:table-cell;text-align:left;padding-left:10px;"><a class="homeIcon" style="cursor:pointer"><img src="/static/hamburger.svg" width="22px" height="22px"></img>  DAQBroker</a><a style="font-size:15px">   Runs</a></div>
	<div style="width:50%;display:table-cell;text-align:right;padding-right:10px;"> <a class="hamburger" style="cursor:pointer"><img src="/static/settings2.png" width="25px" height="25px"></img></a></div>
</div>

{% include 'menus.html' %}<!-- USE THE menus.html file to import the menus -->

<script>

function compareTableCols(a,b) {
  if (a.idx < b.idx)
    return -1;
  if (a.idx > b.idx)
    return 1;
  return 0;
}
var founddbname=false;

/* for (var i=0; i<getStuff.Names.length; i++){
	if(getStuff.Names[i]=='dbname'){
		founddbname=true;
		dbname=getStuff.Values[i];
	}
} */

var test=JSON.parse(sessionStorage.getItem('daqbroker'));
if(test){
	if('dbname' in test){
		dbname=test['dbname'];
		founddbname=true;
	}
}

$(document).ready(function(){
	checkSettings(updateRuns);
});

var timeHidden=0;

var window_focus=true;
$(window).focus(function() {
	window_focus = true;
}).blur(function() {
	window_focus = false;
});

window.setInterval(function(){
	if(window_focus){
		if(timeHidden>300){
			timeHidden=0;
			updateRuns();
		}
		else{
			timeHidden=0;
		}
	}
	else{
		timeHidden=timeHidden+1;
	}
}, 1000);

setupSubscribe()

</script>

<div id="errorDiv" style="color:#a94442;background-color:#f2dede" align="middle">
</div>

<div id="errorLocalDiv" style="color:#a94442;background-color:#f2dede" align="middle">
</div>

<div class="expandErrors-outer" style="display:none">
	<div class="expandErrors"></div>
</div>

<div class="expandErrorsLocal-outer" style="display:none">
	<div class="expandErrorsLocal"></div>
</div>

<div class="loadingStart" style="padding-top:75px;margin:auto;text-align:center">
	<img src="/static/loading.gif" width="70px" height="70px"> </img>
</div>

<div class="content" style="display:none;margin:auto;padding-top:75px">
	<div align="right">
		<a class="button pill huge icon settings editRunlist">Edit run list</a>
	</div>
	<div id="activeRun" style="width:100%">
		<h3 class="display" align="middle">Active Run</h3>
		<table id="activeRunTable" class="display"  cellspacing="0">
			
		</table>
		<div class="buttons" align="middle"></div>
	</div>
	<hr>
	<p align="middle"><img class="loading" src="/static/loading.gif" height="250" width="250"></img></p>
	<div id="runlist" style="width:100%">
		<h3 class="display" align="middle">Stored Runs</h3>
		<table id="runlistTable" class="display" cellspacing="0" >
		
		</table>
	</div>

	<div class="dlButtonDiv" style="maring:auto;text-align:center"><button onclick="setupDownload()" class="dlButton button pill" style="font-size:150%">Download List</button></div>
</div>
<div class="lightboxable-outer" style="display:none">
	<div class="lightboxable"></div>
</div>

</div>

<div class="thefooter">
<div style="margin:auto;text-align:center" class="subscribetDiv"><button class="subscribeButton button pill icon rss">Subscribe to database</button></div>
<span id="year"></span> &copy; <a style="color:white" href="http://daqbroker.com">daqbroker.com</a>
</div>
</div>
<script>
$('#year').append(new Date().getFullYear());
var runTable;
var defaultPars;
var runlistInfoObj={};
var runlistInfoObjOld={};
var onGoingCreation=false;
var remoteRunsOld=[];
var remoteRunsNew=[];
var DAQBroRunsOld=[];
var DAQBroRunsNew=[];
var globalUpdateOngoing=false;
var prohibitedNames=['start','end','active',''];
var firstTime=true;
var timeIdx=[];
var currentRuns=[];
var activeCommentPresesd=false;

function setupDownload(){
	$.ajax({
		method: "POST",
		url:"/runs/getRunList",
		dataType: "json",
		data:{'dbname':dbname},
		success: function(result){
			globalRuns=result;
			$(".lightboxable").empty();
			$(".lightboxable").append('<h2 style="margin:auto;text-align:center">Download Run List</h2><hr style="width:25%"><div class="downloadOptions"></div>');
			$(".lightboxable").find('.downloadOptions').append('<p style="padding:15px 0 15px 0">File name : <input class="filename inputdl" placeholder="runlist.txt"></input></p>');
			$(".lightboxable").find('.downloadOptions').append('<p style="padding:15px 0 15px 0">Separator <select class="separator inputdl"><option selected value="tab">Tab</option><option value="colon">Colon</option></select></p>');
			$(".lightboxable").find('.downloadOptions').append('<p style="padding:15px 0 15px 0">Time format <select class="timeFormat inputdl"><option selected value="unix">Unix Timestamp</option><option  value="matlab">Matlab</option><option  value="igor">Igor</option><option value="string">Time String</option></select></p>');
			//$(".lightboxable").find('.downloadOptions').append('<p style="padding:15px 0 15px 0">Time format (<a href="https://momentjs.com/docs/#/displaying/">Reference</a>): <input class="timeFormat inputdl"></input><span class="timeError" style="background-color:#f2dede"></span></p>');
			$(".lightboxable").find('.downloadOptions').append('<div class="buttonDiv" style="margin:auto;text-align:center"></div>');
			$(".lightboxable").find('.inputdl').change(function(){
				var theSeparator=$(".lightboxable").find('.downloadOptions').find('.separator').val();
				var tFormat=$(".lightboxable").find('.downloadOptions').find('.timeFormat').val();
				var filename=$(".lightboxable").find('.downloadOptions').find('.filename').val();
				$(".lightboxable").find('.buttonDiv').empty();
				var theList='';
				var listKeys=Object.keys(globalRuns[0]);
				if(theSeparator=='tab'){
					var actualSep='\t';
				}
				if(theSeparator=='comma'){
					var actualSep=',';
				}
				if(theSeparator=='colon'){
					var actualSep=';';
				}
				goodStuff=[];
				for (var i=0; i<listKeys.length; i++){
					if(listKeys[i]!='comments' && listKeys[i]!='active'){
						goodStuff.push(listKeys[i]);
					}
				}
				goodStuff.push('comments');
				theList=goodStuff.join(actualSep)+'\n';
				for (var j=0; j<globalRuns.length; j++){
					var theRun=globalRuns[j];
					var listKeys=Object.keys(theRun);
					if(tFormat=='unix'){
						var theStart=theRun.start;
						var theEnd=theRun.end;
					}
					if(tFormat=='matlab'){
						var theStart=Number(theRun.start)/86400000 + 719529;
						var theEnd=Number(theRun.end)/86400000 + 719529;
					}
					if(tFormat=='igor'){
						var theStart=(Number(theRun.start)-moment.utc("01-01-1904", "MM-DD-YYYY").valueOf())/1000;
						var theEnd=(Number(theRun.end)-moment.utc("01-01-1904", "MM-DD-YYYY").valueOf())/1000;
					}
					if(tFormat=='string'){
						var theStart=moment.utc(Number(theRun.start)).format('DD/MM/YYYY HH:mm:ss');
						var theEnd=moment.utc(Number(theRun.end)).format('DD/MM/YYYY HH:mm:ss');
					}
					try {
						var runComments=JSON.parse(globalRuns[j].comments);
					}
					catch(err) {
						var runComments=[];
					}
					if(runComments!=null){
						if(!(runComments.length>0)){
							runComments=[];
						}
						else{
							if(!('time' in runComments[0])){
								runComments=[];
							}
						}
					}
					else{
						runComments=[];
					}
					for (var i=0; i<runComments.length; i++){
						//s.replace(/[\[\]&]+/g, '');
						var theComment=runComments[i];
						if(tFormat=='matlab'){
							runComments[i].time=Number(theComment.time)/86400000 + 719529;
						}
						if(tFormat=='igor'){
							runComments[i].time=(Number(theComment.time)-moment.utc("01-01-1904", "MM-DD-YYYY").valueOf())/1000;
						}
						if(tFormat=='string'){
							runComments[i].time=moment.utc(Number(theComment.time)).format('DD/MM/YYYY HH:mm:ss');
						}
						runComments[i].comment=runComments[i].comment.split('\n').join(' ');
						runComments[i].comment=runComments[i].comment.split(actualSep).join(' ');
					}
					var pars=[];
					for (var i=0; i<listKeys.length; i++){
						if(listKeys[i]!='comments' && listKeys[i]!='active' && listKeys[i]!='end' && listKeys[i]!='start'){
							pars.push(theRun[listKeys[i]]);
						}
					}
					theList=theList+theStart+actualSep+theEnd+actualSep+pars.join(actualSep)+actualSep+JSON.stringify(runComments)+'\n';
				}
				var file = new File([theList], filename, {type: "text/plain"});
				var fileURL=URL.createObjectURL(file);
				$(".lightboxable").find('.buttonDiv').append('<a href='+fileURL+' download="'+filename+'" class="button pill downloadList" style="font-size:150%">Download</a>');
				$.colorbox.resize();
			});
			$.colorbox({
				inline:true,
				href:$(".lightboxable"),
				onOpen:function(){
					$(".lightboxable-outer").show();
				},
				onCleanup:function(){
					$(".lightboxable-outer").hide();
				},
				width:"75%",
				maxWidth: "1000px",
				closeButton	:false
			});
		},
		error:function(returned){
			alert('There was an error retrieving the runlist');
		}
	});
}

function updateGlobal(){
	globalUpdateOngoing=false;
}


var window_focus=true;
$(window).focus(function() {
	window_focus = true;
}).blur(function() {
	window_focus = false;
});

$(".loading").hide();

function updateRuns(theCallback){
	console.log("THIS IS IT!");
	$(".content").show();
	$(".loadingStart").hide();
	if(!globalUpdateOngoing){
		globalUpdateOngoing=true;
		$.ajax({
			url: '/runs/getRunListInfo',
			type: 'POST',
			dataType: "json",
			data:{'database':dbname},
			success: function(returned){
				var runlistInfo=returned;
				$(".editRunlist").click(function(){
					editList(runlistInfoObj,3);
				});
				if(!jQuery.isEmptyObject(runlistInfo)){
					runlistInfoObj=runlistInfo;
					for (var i=runlistInfoObj.runlistRemarks.cols.length-1; i>=0; i--){
						if(runlistInfoObj.runlistRemarks.cols[i].action=='deleteOld'){
							runlistInfoObj.runlistRemarks.cols.splice(i,1);
							runlistInfoObj.runlistRemarks.noHeaderCols=runlistInfoObj.runlistRemarks.noHeaderCols-1;
						}
					}
					//runlistInfoObj.linkRemarks=JSON.parse(runlistInfoObj.linkRemarks);
					//runlistInfoObj.runlistRemarks=JSON.parse(runlistInfoObj.runlistRemarks);
					if(Number(runlistInfoObj.linkType)>0){
						runlistInfoObj.toPropagate={
							'headerLine' : runlistInfoObj.linkRemarks.headerLine,
							'sheetID'    : runlistInfoObj.linkRemarks.sheetID
						};
					}
					runlistInfoObj['isNewRunlist']=false;
					runlistInfoObjOld=runlistInfoObj;
					checkRuns(runlistInfoObj,showTable,theCallback);
				}
				else{
					if(!firstTime){
						location.reload();
					}
					else{
						editList({},0);
					}
				}
			},
			error: function(returnedError){
				alert('There was an error while loading runlist information');
			}
		});
	}
}

var originalClose=$.colorbox.close;
$.colorbox.close=function(){
	var response;
	if(onGoingCreation){
		response = confirm('You have unsaved changes on your run list, are you sure you want to close this window?');
		if(!response){
			return;
		}
	}
	onGoingCreation=false;
	originalClose();
};

function editList(listObjct,step){
	if(jQuery.isEmptyObject(listObjct)){//Empty object - considered to be making a new run
		var nowDate=new Date();
		var nextCallback=editList;
		runlistInfoObj={
			'clock'           : String(nowDate.getTime()),
			'isLinked'        : false,
			'linkRemarks'     : {},
			'runlistType'     : 0,
			'runlistRemarks'  : {
				'cols'      : []
			},
			'reviewing'       : false,
			'isNewRunlist'    : true,
		};
		var params=[runlistInfoObj,3];
		theBox=$.confirm({
			title: 'DAQBroker runlist manager',
			content: 'It seems there is no available runlist information. The following wizard will help you setup a new runlist in DAQBroker.',
			buttons: {
				next:{
					action :function () {
						theBox.close();
						nextCallback.apply(null,params);
					},
					text: 'Next',
				},
				cancel:{
					action: function () {},
					text: 'Cancel',
					btnClass: 'btn-red'
				},
			},
			contentLoaded:function(){
				changedColorboxInputs();
			}
		});
		$(".lightboxable").empty();
	}
	else{
		onGoingCreation=true;
		for (var i=0; i<listObjct.runlistRemarks.cols.length; i++){
			if(listObjct.runlistRemarks.cols[i].action=='addOld'){
				listObjct.runlistRemarks.cols[i].action='edit';
			}
		}
		if(step==1){
			var nextCallback=editList;
			var params=[listObjct,2];
			theBox=$.confirm({
				title: 'DAQBroker runlist manager',
				content: $(".lightboxable").html(),
				buttons: {
					next:{
						action :function () {
							nextCallback.apply(null,params);
						},
						text: 'Next',
					},
					cancel:{
						action: function () {},
						text: 'Cancel',
						btnClass: 'btn-red'
					},
				}
			});
			$(".lightboxable").empty();
			$(".lightboxable").append('<input class="stepNo" hidden value="'+step+'"></input>');
			$(".lightboxable").append('<p class="buttonPar"><button class="stepButton" value="1" disabled>Step 1</button><button value="2" class="stepButton" >Step 2</button></p><h3>Runlist type</h3><p>I would like to <select class="runlistType inputInfo"><option selected hidden disabled>--- SELECT ONE ---</option><option value="0">Create a brand new runlist</option><option disabled value="1">Use a Google spreadsheet runlist</option></select></p><p><input type="button" value="Next" class="next" style="float: right;"></p>');
			if(!jQuery.isEmptyObject(listObjct.runlistRemarks)){
				$(".lightboxable").find('.buttonPar').append('<button class="stepButton" value="3">Step 3</button>');
			}
			if(listObjct.reviewing){
				$(".lightboxable").find('.buttonPar').append('<button class="stepButton" value="4">Review</button>');
			}
			$(".lightboxable").find(".next").unbind("click");
			var infoKeys=Object.keys(listObjct);
			changedColorboxInputs();
		}
		if(step==2){
			var nextCallback=editList;
			var params=[listObjct,3];
			theBox=$.confirm({
				title: 'DAQBroker runlist manager',
				content: $(".lightboxable").html(),
				buttons: {
					next:{
						action :function () {
							nextCallback.apply(null,params);
						},
						text: 'Next',
					},
					cancel:{
						action: function () {},
						text: 'Cancel',
						btnClass: 'btn-red'
					},
				}
			});
			$(".lightboxable").empty();
			$(".lightboxable").append('<p class="buttonPar"><button value="1" class="stepButton">Step 1</button><button disabled >Step 2</button></p>');
			if(!jQuery.isEmptyObject(listObjct.runlistRemarks)){
				$(".lightboxable").find('.buttonPar').append('<button class="stepButton" value="3">Step 3</button>');
			}
			if(listObjct.reviewing){
				$(".lightboxable").find('.buttonPar').append('<button class="stepButton" value="4">Review</button>');
			}
			if(listObjct.runlistType=="0"){
				if(listObjct.isNewRunlist && !listObjct.reviewing){
					runlistInfoObj.runlistRemarks.cols=[];
					runlistInfoObj.runlistRemarks.cols.push({'name': 'Col 0', 'type':0,'parType':3,'action':'add'});
					runlistInfoObj.runlistRemarks.cols.push({'name': 'Col 1', 'type':0,'parType':0,'action':'add'});
					runlistInfoObj.runlistRemarks.noHeaderCols=2;
				}
				editList(listObjct,3);
			}
			else if(listObjct.runlistType=="1"){
				$(".lightboxable").append('<h3>Runlist info</h3><p>Please provide the google <a href="https://developers.google.com/sheets/api/guides/concepts#spreadsheet_id" target="_blank">spreadsheet ID</a> and <a id="scriptID" href="#scriptID">DAQBroker\'s script ID</a></p><p><input class="gsheetid spreadsheetID" placeholder="Sheet ID"></input></p><p><input class="gsheetid scriptID" placeholder="Script ID"></input></p>');
				$(".lightboxable").find('.gsheetid.scriptID').val(listObjct.linkRemarks.gscript);
				$(".lightboxable").find('.gsheetid.spreadsheetID').val(listObjct.linkRemarks.gspreadsheet);
			}
			changedColorboxInputs();
		}
		if(step==3){
			if(listObjct.isNewRunlist && !listObjct.reviewing){
				runlistInfoObj.runlistRemarks.cols=[];
				runlistInfoObj.runlistRemarks.cols.push({'name': 'Col 0', 'type':3,'action':'add'});
				runlistInfoObj.runlistRemarks.cols.push({'name': 'Col 1', 'type':0,'action':'add'});
				runlistInfoObj.runlistRemarks.noHeaderCols=2;
			}
			var nextCallback=function(listObjct,step){
				theBox.close();
				editList(runlistInfoObj,4);
			};
			var params=[listObjct,4];
			if(!jQuery.isEmptyObject(listObjct.runlistRemarks)){
				startValue=listObjct.runlistRemarks.noHeaderCols;
			}
			theBox=$.confirm({
				title: 'Runlist - Parameter definition',
				content: '<p class="buttonPar"><button class="stepButton" value="3">Step 1</button><button class="stepButton" value="4">Review</button></p><hr style="width:25%"><h3>Runlist info</h3><p>Number of header columns <input type="number" value="'+startValue+'" min="2" step="1" class="runlistInput noHeaderCols"></input></p><div class="headersDiv"></div>',
				buttons: {
					next:{
						action :function () {
							nextCallback.apply(null,params);
						},
						text: 'Next',
					},
					cancel:{
						action: function () {},
						text: 'Cancel',
						btnClass: 'btn-red'
					},
				},
				useBootstrap: false,
				onOpen:function(){
					if(listObjct.reviewing){
						$(".lightboxable").find('.buttonPar').append('<button class="stepButton" value="4">Review</button>');
					}
					var startValue=0;
					if(!jQuery.isEmptyObject(listObjct.runlistRemarks)){
						startValue=listObjct.runlistRemarks.noHeaderCols;
					}
					if(!listObjct.isNewRunlist || listObjct.reviewing){
						theBox.$content.find('.noHeaderCols').prop('disabled',true);
						theBox.$content.find('.noHeaderCols').after('<button class="addHeader button icon add"></button>');
						theBox.$content.find('.addHeader').click(function(){
							listObjct.runlistRemarks.noHeaderCols=Number(listObjct.runlistRemarks.noHeaderCols)+1;
							listObjct.runlistRemarks.cols.push({
								'name':'Col '+listObjct.runlistRemarks.noHeaderCols,
								'type':'0',
								'parType':'1',
								'action':'add'
							});
							theBox.$content.find('.noHeaderCols').val(Number(theBox.$content.find('.noHeaderCols').val())+1);
							$(".headersDiv").append('<p><button class="delHeader '+(Number(listObjct.runlistRemarks.noHeaderCols)-1)+' button icon remove danger"></button><input class="colStuff colNames '+(Number(listObjct.runlistRemarks.noHeaderCols)-1)+'" value="'+listObjct.runlistRemarks.cols[Number(listObjct.runlistRemarks.noHeaderCols)-1].name+'"></input> Type: <select class="colStuff colType '+(Number(listObjct.runlistRemarks.noHeaderCols)-1)+'"><option value="0" selected>Parameter</option><option value="1">Start Time</option><option value="2">End Time (optional)</option><option value="3">Run Identifier</option></option><option value="4">Option</option> </select></p>');
							theBox.$content.find('.headersDiv').find('.delHeader.'+(Number(listObjct.runlistRemarks.noHeaderCols)-1)).click(function(){
								var indexDel=Number($(this).prop('class').split(' ')[1]);
								if(listObjct.runlistRemarks.cols[indexDel].action=="add"){
									listObjct.runlistRemarks.cols[indexDel].action="deleteNow";
								}
								else{
									listObjct.runlistRemarks.cols[indexDel].action="delete";
								}
								$(".noHeaderCols").val(Number($(".noHeaderCols").val())-1);
								listObjct.runlistRemarks.noHeaderCols=listObjct.runlistRemarks.noHeaderCols-1;
								$($(this).parent()).remove();
							});
							$(".headersDiv").find('.colStuff.'+(Number(listObjct.runlistRemarks.noHeaderCols)-1)).change(function(){
								$this=$(this);
								var element=$this;
								index=Number($this.attr('class').split(" ")[2]);
								setRunlistCols(index,element);
								if(runlistInfoObj.runlistRemarks["cols"][index].action!="add" && runlistInfoObj.runlistRemarks["cols"][index].action!="delete"){
									runlistInfoObj.runlistRemarks["cols"][index].action="edit";
								}
							});
							changedColorboxInputs();
							$(".headersDiv").find('.colStuff.colType.'+(Number(listObjct.runlistRemarks.noHeaderCols)-1)).trigger('change');
							$(".headersDiv").find('.parTypeSelect.'+(Number(listObjct.runlistRemarks.noHeaderCols)-1)).val(listObjct.runlistRemarks.cols[Number(listObjct.runlistRemarks.noHeaderCols)-1].parType);
						});
					}
					changedColorboxInputs();
					if(!jQuery.isEmptyObject(listObjct.runlistRemarks)){
						theBox.$content.find('.noHeaderCols').val(listObjct.runlistRemarks.noHeaderCols);
						theBox.$content.find('.noHeaderCols').trigger('change');
						if(!(typeof listObjct.runlistRemarks.cols==='undefined')){
							if(listObjct.runlistRemarks.cols.length>0){
								for (var i=0; i<listObjct.runlistRemarks.cols.length; i++){
									theBox.$content.find('.colNames.'+i).val(listObjct.runlistRemarks.cols[i].name);
									theBox.$content.find('.colType.'+i).val(listObjct.runlistRemarks.cols[i].type);
									theBox.$content.find('.colType.'+i).trigger('change');
									if(listObjct.runlistRemarks.cols[i].type=="0"){
										if(!(typeof listObjct.runlistRemarks.cols[i].parType === "undefined")){
											theBox.$content.find('.parTypeSelect.'+i).val(listObjct.runlistRemarks.cols[i].parType);
										}
										else{
											theBox.$content.find('.parTypeSelect.'+i).val("1");
										}
										theBox.$content.find('.parTypeSelect.'+i).trigger('change');
										if(listObjct.runlistRemarks.cols[i].parType==="0"){
											theBox.$content.find('.parTypeSelect.'+i).parent().find('.parTypeUnit').val(listObjct.runlistRemarks.cols[i].parUnits)
										}
									}
								}
							}
						}
						$.colorbox.resize();
					}
				}
			});
		}
		if(step==4){
			var nextCallback=submitRunlistData;
			var params=[runlistInfoObj];
			theBox=$.confirm({
				title: 'Runlist - Review & submit',
				content: '<p><button class="stepButton" value="3">Step 1</button><button disabled value="4">Review</button></p><hr><h4>Review and finish</h4><p>Unique identifier columns:<span style="font-weight: bold" class="emphasis uniqueCols"></span></p><p>Parameter columns:<span style="font-weight: bold" class="emphasis parCols"></span></p><p>Options columns:<span style="font-weight: bold" class="emphasis optCols"></span></p>',
				buttons: {
					next:{
						action :function () {
							nextCallback.apply(null,params);
						},
						text: 'Submit',
					},
					cancel:{
						action: function () {},
						text: 'Cancel',
						btnClass: 'btn-red'
					},
				},
				onOpen:function(){
					runlistInfoObj.reviewing=true;
					var startStr='';
					var endStr='';
					var parStr='';
					var optStr='';
					var uniqueStr='';
					for (var i=listObjct.runlistRemarks.cols.length-1; i>=0; i--){
						var color='';
						var underline='';
						var backgroundColor='';
						var toWrite=true;
						if(listObjct.runlistRemarks.cols[i].action=='add'){
							color='#3c763d';
							underline='auto';
							backgroundColor='#dff0d8';
						}
						else if(listObjct.runlistRemarks.cols[i].action=='delete'){
							color='#a94442';
							underline='line-through';
							backgroundColor='#f2dede';
						}
						else if(listObjct.runlistRemarks.cols[i].action=='deleteNow'){
							toWrite=false;
						}
						else{
							color='auto';
							underline='auto';
							backgroundColor='auto';
						}
						if(toWrite){
							if(listObjct.runlistRemarks.cols[i].type==0){
								if(listObjct.runlistRemarks.cols[i].parType=="0"){
									if(parStr==''){
										parStr='<span style="background-color:'+backgroundColor+';color:'+color+';text-decoration:'+underline+'">'+listObjct.runlistRemarks.cols[i].name+' ('+listObjct.runlistRemarks.cols[i].parUnits+')</span>';
									}
									else{
										parStr=parStr+',<span style="background-color:'+backgroundColor+';color:'+color+';text-decoration:'+underline+'">'+listObjct.runlistRemarks.cols[i].name+' ('+listObjct.runlistRemarks.cols[i].parUnits+')</span>';
									}
								}
								else{
									if(parStr==''){
										parStr='<span style="background-color:'+backgroundColor+';color:'+color+';text-decoration:'+underline+'">'+listObjct.runlistRemarks.cols[i].name+'</span>';
									}
									else{
										parStr=parStr+',<span style="background-color:'+backgroundColor+';color:'+color+';text-decoration:'+underline+'">'+listObjct.runlistRemarks.cols[i].name+'</span>';
									}
								}
							}
							if(listObjct.runlistRemarks.cols[i].type==3){
								if(uniqueStr==''){
									uniqueStr='<span style="background-color:'+backgroundColor+';color:'+color+';text-decoration:'+underline+'">'+listObjct.runlistRemarks.cols[i].name+'</span>';
								}
								else{
									uniqueStr=uniqueStr+',<span style="background-color:'+backgroundColor+';color:'+color+';text-decoration:'+underline+'">'+listObjct.runlistRemarks.cols[i].name+'</span>';
								}
							}
							if(listObjct.runlistRemarks.cols[i].type==4){
								if(optStr==''){
									optStr='<span style="background-color:'+backgroundColor+';color:'+color+';text-decoration:'+underline+'">'+listObjct.runlistRemarks.cols[i].name+':'+JSON.stringify(listObjct.runlistRemarks.cols[i].optionValues)+'</span>';
								}
								else{
									optStr=optStr+' , <span style="background-color:'+backgroundColor+';color:'+color+';text-decoration:'+underline+'">'+listObjct.runlistRemarks.cols[i].name+':'+JSON.stringify(listObjct.runlistRemarks.cols[i].optionValues)+'</span>';
								}
							}
						}
					}
					for (var i=listObjct.runlistRemarks.cols.length-1; i>=0; i--){
						if(listObjct.runlistRemarks.cols[i].action=='deleteNow'){
							listObjct.runlistRemarks.cols.splice(i,1);
						}
					}
					if(startStr!=''){
						theBox.$content.find('.startTimeCols').html(startStr);
					}
					if(endStr!=''){
						theBox.$content.find('.endTimeCols').html(endStr);
					}
					if(parStr!=''){
						theBox.$content.find('.parCols').html(parStr);
					}
					if(optStr!=''){
						theBox.$content.find('.optCols').html(optStr);
					}
					if(uniqueStr!=''){
						theBox.$content.find('.uniqueCols').html(uniqueStr);
					}
					changedColorboxInputs();
				}
			});
		}
	}
}

function changedColorboxInputs(){
	theBox.$content.find('.emphasis').css('font-weight','bold');
	theBox.$content.find('.inputInfo').unbind('change');
	theBox.$content.find('.runlistInput').unbind('change');
	theBox.$content.find('.runlistInput').change(function(){
		if($(this).attr('class').includes('noHeaderCols')){
			informed=false;
			if(jQuery.isEmptyObject(runlistInfoObj.runlistRemarks)){
				runlistInfoObj.runlistRemarks['noHeaderCols']=Number($(this).val());
				runlistInfoObj.runlistRemarks['cols']=[];
				for (var i=0; i<runlistInfoObj.runlistRemarks.noHeaderCols; i++){
					runlistInfoObj.runlistRemarks['cols'].push({});
				}
			}
			else{
				if(Number($(this).val())<runlistInfoObj.runlistRemarks['noHeaderCols']){
					runlistInfoObj.runlistRemarks['cols']=runlistInfoObj.runlistRemarks['cols'].slice(0,Number($(this).val())-1);
					/*runlistInfoObj.runlistRemarks['cols']=[];
					for (var i=0; i<runlistInfoObj.runlistRemarks.noHeaderCols; i++){
						runlistInfoObj.runlistRemarks['cols'].push({});
					}*/
				}
				else{
					var diff=Number($(this).val())-runlistInfoObj.runlistRemarks['noHeaderCols'];
					for (var i=0; i<diff; i++){
						runlistInfoObj.runlistRemarks['cols'].push({
							'name':'Col '+(runlistInfoObj.runlistRemarks['noHeaderCols']+i),
							'type':'0',
							'parType':'1',
							'action':'add'
						});
					}
				}
				runlistInfoObj.runlistRemarks['noHeaderCols']=Number($(this).val());
			}
			theBox.$content.find('.headersDiv').unbind('change');
			theBox.$content.find('.headersDiv').empty();
			theBox.$content.find('.headersDiv').append('<p>Column information</p>');
			for (var i=0; i<runlistInfoObj.runlistRemarks.cols.length; i++){
				if(runlistInfoObj.runlistRemarks.cols[i].action!="delete"){
					if(runlistInfoObj.runlistRemarks.cols[i].action=='add'){
						console.log(runlistInfoObj.runlistRemarks.cols[i]["type"]);
						theBox.$content.find('.headersDiv').append('<p style="background-color:#dff0d8;cursor:help;" title="This parameter will be added to the database\'s runlist"><button class="delHeader '+i+' button icon remove danger"></button><input class="colStuff colNames '+i+'" type="text" value="'+runlistInfoObj.runlistRemarks.cols[i]["name"]+'"></input> Type: <select value="'+runlistInfoObj.runlistRemarks.cols[i]["type"]+'" class="colStuff colType '+i+'"><option value="0">Parameter</option><option value="3">Run indentifier</option><option value="4">Option</option></select></p>');
						theBox.$content.find('.headersDiv').find('.colStuff.colType.'+i).val(runlistInfoObj.runlistRemarks.cols[i]["type"]);
						theBox.$content.find('.headersDiv').find('.delHeader.'+i).click(function(){
							var indexDel=Number($(this).prop('class').split(' ')[1]);
							runlistInfoObj.runlistRemarks.cols[indexDel].action="delete";
							$(".noHeaderCols").val(Number($(".noHeaderCols").val())-1);
							runlistInfoObj.runlistRemarks.noHeaderCols=runlistInfoObj.runlistRemarks.noHeaderCols-1;
							$($(this).parent()).remove();
						});
					}
					else{
						theBox.$content.find('.headersDiv').append('<p><button class="delHeader '+i+' button icon remove danger"></button><input class="colStuff colNames '+i+'" type="text" value="'+runlistInfoObj.runlistRemarks.cols[i]["name"]+'"></input> Type: <select value="'+runlistInfoObj.runlistRemarks.cols[i]["type"]+'" class="colStuff colType '+i+'"><option value="0">Parameter</option><option value="3">Run indentifier</option><option value="4">Option</option></select></p>');
						theBox.$content.find('.headersDiv').find('.delHeader.'+i).click(function(){
							var indexDel=Number($(this).prop('class').split(' ')[1]);
							runlistInfoObj.runlistRemarks.cols[indexDel].action="delete";
							$(".noHeaderCols").val(Number($(".noHeaderCols").val())-1);
							runlistInfoObj.runlistRemarks.noHeaderCols=runlistInfoObj.runlistRemarks.noHeaderCols-1;
							$($(this).parent()).remove();
						});
					}
				}
				else{
					var type='';
					var text=''
					if(Number(runlistInfoObj.runlistRemarks.cols[i].type)==0){
						type='Parameter';
						text='<p style="background-color:#f2dede">Deleted: <span style="font-weight:700">'+runlistInfoObj.runlistRemarks.cols[i].name+'</span>  Type:<span style="font-weight:700">'+type+'</span></p>';
					}
					else if(Number(runlistInfoObj.runlistRemarks.cols[i].type)==3){
						type='Run Identifier';
						text='<p style="background-color:#f2dede">Deleted: <span style="font-weight:700">'+runlistInfoObj.runlistRemarks.cols[i].name+'</span>  Type:<span style="font-weight:700">'+type+'</span></p>';
					}
					else if(Number(runlistInfoObj.runlistRemarks.cols[i].type)==4){
						type='Option';
						text='<p style="background-color:#f2dede">Deleted: <span style="font-weight:700">'+runlistInfoObj.runlistRemarks.cols[i].name+'</span>  Type:<span style="font-weight:700">'+type+'</span></p>';
					}
					$(".lightboxable").find('.headersDiv').append(text);
				}
			}
			console.log(theBox.$content.find('.headersDiv').find('.colStuff.colType.0').val());
			theBox.$content.find('.headersDiv').find('.colStuff').change(function(){
				$this=$(this);
				var element=$this;
				index=Number($this.attr('class').split(" ")[2]);
				setRunlistCols(index,element);
				if(runlistInfoObj.runlistRemarks["cols"][index].action!="add" && runlistInfoObj.runlistRemarks["cols"][index].action!="delete"){
					runlistInfoObj.runlistRemarks["cols"][index].action="edit";
				}
			});
			if(runlistInfoObj.isNewRunlist && !runlistInfoObj.reviewing){
				theBox.$content.find('.headersDiv').find('.colStuff').trigger('change');
			}
		}
		$.colorbox.resize();
	});

	var keys=Object.keys(runlistInfoObj);
	theBox.$content.find('.stepButton').click(function(){
		$(".lightboxable").unbind('change');
		$this=$(this);
		var stepNo=Number($this.val());
		editList(runlistInfoObj,stepNo);
	});
	theBox.$content.find('.inputInfo').change(function(){
		$this=$(this);
		var thisClass=$this.attr('class');
		var infoKeys=Object.keys(runlistInfoObj);
		var foundInfo=-1;
		var found=-1;
		for (var i=0; i<infoKeys.length; i++){
			if(thisClass.includes(infoKeys[i])){
				foundInfo=i;
			}
		}
		if(foundInfo>=0){
			if($this.attr("type")=="checkbox"){
				runlistInfoObj[infoKeys[foundInfo]]=$this.prop('checked');
			}
			else if($this.attr("type")=="textarea"){
				runlistInfoObj[infoKeys[foundInfo]]=$this.html();
			}
			else{
				runlistInfoObj[infoKeys[foundInfo]]=$this.val();
			}
		}
		if(thisClass.includes('runlistType')){
			if($this.val()=="1"){
				if($(".lightboxable").find(".isLinked").length<1){
					theBox.$content.find('.runlistType').after('<p class="isLinkedPar"><input class="isLinked inputInfo" type="checkbox">Link tables</input></p>');
					changedColorboxInputs();
				}
			}
			else{
				theBox.$content.find(".isLinkedPar").remove();
			}
			runlistInfoObj.isNewRunlist=true;
		}
	});
	$.colorbox.resize();
}

function setRunlistCols(idx,el){
	var foundStart=false;
	var foundUnique=false;
	var allformatFilled=true;
	var duplicatesFound=false;
	//Change name
	if(el.attr("class").includes('colNames')){
		if(typeof runlistInfoObj.runlistRemarks["cols"][idx]==='undefined'){
			runlistInfoObj.runlistRemarks["cols"][idx]={'type':0,'name':el.val()};
		}
		else{
			runlistInfoObj.runlistRemarks["cols"][idx]["name"]=el.val();
		}
	}
	if(el.attr("class").includes('colType')){
		if(typeof runlistInfoObj.runlistRemarks["cols"][idx]==='undefined'){
			runlistInfoObj.runlistRemarks["cols"][idx]={'type':0,'name':el.val()};
		}
		else{
			runlistInfoObj.runlistRemarks["cols"][idx]["type"]=el.val();
			$($this.parent()).find('parType').remove();
		}
		if(Number($this.val())==0){
			$($this.parent()).find('.parType').remove();
			$($this.parent()).append('<span class="parType '+idx+'"> Type : <select class="parTypeSelect '+idx+'"><option value="0"> Number </option><option value="1"> Text </option></select></span>');
			$($this.parent()).find('.parTypeSelect').val(runlistInfoObj.runlistRemarks.cols[idx].parType);
			$($this.parent()).find('.parTypeSelect').change(function(){
				if($(this).val()=="0"){
					$($(this).parent()).append('<span class="parTypeUnitSpan"> | Units : <input class="parTypeUnit"></input></span>');
					$($(this).parent()).find('.parTypeUnit').on('input',function(){
						runlistInfoObj.runlistRemarks.cols[idx]['parUnits']=$(this).val();
					});
				}
				else{
					$($(this).parent()).find(".parTypeUnitSpan").remove();
				}
				runlistInfoObj.runlistRemarks.cols[idx]['parType']=$(this).val();
			});
			//$($this.parent()).find('.parTypeSelect').trigger('change');
		}
		else if(Number(el.val())==4){
			$($this.parent()).find('.parType').remove();
			if((typeof runlistInfoObj.runlistRemarks.cols[idx]['optionValues'])==='undefined'){
				runlistInfoObj.runlistRemarks.cols[idx]['optionValues']=[];
			}
			else{
				displayParOptions($($this.parent()),idx);
				console.log($($this.parent()));
			}
			$(el.parent()).append('<span class="parType '+idx+'"> Add Option <input class="addOption '+idx+'"></input><button class="submitOption '+idx+' button pill icon add"></button></span>');
			$(el.parent()).find('.submitOption').click(function(){
				var theIdx=Number($(this).prop('class').split(' ')[1]);
				var theValue=$($(this).parent()).find('.addOption').val();
				if(theValue==''){
					theBox.$content.find('.headersDiv').find('.headerError').remove();
					theBox.$content.find('.headersDiv').prepend('<span class="headerError" style="margin:auto;text-align:center;align:center;background-color:#f2dede">Option field empty!</span>');
					theBox.$content.find('.headersDiv').find('.headerError').fadeOut(2000,function(){
						theBox.$content.find('.headersDiv').find('.headerError').remove();
					});
				}
				else if(runlistInfoObj.runlistRemarks.cols[idx]['optionValues'].indexOf(theValue)<0){
					runlistInfoObj.runlistRemarks.cols[idx]['optionValues'].push(theValue);
				}
				else{
					theBox.$content.find('.headersDiv').find('.headerError').remove();
					theBox.$content.find('.headersDiv').prepend('<span class="headerError" style="margin:auto;text-align:center;align:center;background-color:#f2dede">Option already exists</span>');
					theBox.$content.find('.headersDiv').find('.headerError').fadeOut(2000,function(){
						theBox.$content.find('.headersDiv').find('.headerError').remove();
					});
				}
				displayParOptions($($(this).parent()),theIdx);
			});
		}
		else{
			$(el.parent()).find('.parType').remove();
			$(el.parent()).find('.dateFormatSpan').remove();
		}
		var foundStart=false;
		var foundUnique=false;
		var allformatFilled=true;
		theBox.$content.find('.headersDiv').find('.colType').each(function(){
			$this=$(this);
			var idx=Number($this.attr('class').split(" ")[2]);
			if(Number($this.val())==3){
				foundUnique=true;
			}
		});
		if(foundUnique){
			theBox.buttons.next.enable();
		}
		else{
			if(!informed){
				var n=new Noty({
					text    :  'You must to at least provide a ONE run identifier column',
					theme     :  'relax',
					type      :  'warning',
					timeout   :  3000,
					callbacks:{
						onClose: function(){
							informed=false;
						}
					}
				}).show();
				informed=true;
			}
			theBox.buttons.next.disable();
		}
	}
	theBox.$content.find('.headersDiv').find('.colNames').each(function(){
		var compared=$(this);
		$(compared.parent()).find('.error').remove();
		theBox.$content.find('.headersDiv').find('.colNames').each(function(){
			if(compared.val()==$(this).val() && compared.attr('class')!=$(this).attr('class')){
				duplicatesFound=true;
				$($(this).parent()).append('<span class="error" style="color:red">Duplicate name found</span>');
				$(compared.parent()).append('<span class="error" style="color:red">Duplicate name found</span>');
				compared.focus();
			}
		});
	});
	/*theBox.$content.find('.headersDiv').find('.colType').each(function(){
		$this=$(this);
		var idx=Number($this.attr('class').split(" ")[2]);
		if($($this.parent()).find('.dateFormat').val()==''){
			allformatFilled=false;
		}
		if(Number($this.val())==1){
			foundStart=true;
		}
		if(Number($this.val())==3){
			foundUnique=true;
		}
		$(".lightboxable").find('.next').remove();
		if(foundStart && foundUnique && !duplicatesFound){
			$(".lightboxable").append('<p><input type="button" value="Next" class="next" style="float: right;"></p>');
			$(".lightboxable").find(".next").click(function(){
				/*var theThings=[];
				var theOtherThings=[];
				for (var i=0; i<runlistInfoObj.runlistRemarks.cols.length; i++){
					console.log(runlistInfoObj.runlistRemarks.cols[i]);
					theThings.push(runlistInfoObj.runlistRemarks.cols[i].action);
					if(runlistInfoObj.runlistRemarks.cols[i].action=='delete'){
						theOtherThings.push(runlistInfoObj.runlistRemarks.cols[i].name);
					}
					else{
						theOtherThings.push('')
					}
				}
				runlistInfoObj.runlistRemarks.noHeaderCols=Number($(".lightboxable").find('.noHeaderCols').val());
				runlistInfoObj.runlistRemarks.cols=[];
				for (var i=0; i<runlistInfoObj.runlistRemarks.noHeaderCols; i++){
					runlistInfoObj.runlistRemarks.cols.push({'name':$(".lightboxable").find('.colNames.'+i).val(),'type':$(".lightboxable").find('.colType.'+i).val(),'action':theThings[i]});
					if(runlistInfoObj.runlistRemarks.cols[i].type=="0"){
						runlistInfoObj.runlistRemarks.cols[i].parType=$($(".lightboxable").find('.colNames.'+i).parent()).find(".parTypeSelect").val();
						if(runlistInfoObj.runlistRemarks.cols[i].parType=="0"){
							runlistInfoObj.runlistRemarks.cols[i].parUnits=$($(".lightboxable").find('.colNames.'+i).parent()).find(".parTypeUnit").val();
						}
					}
					if(runlistInfoObj.runlistRemarks.cols[i].type=="4"){
						runlistInfoObj.runlistRemarks.cols[i].optionValues=[];
						var options=$(".lightboxable").find('.optionParameterOptions.'+i).find('.option');
						for (var j=0; j<options.length; j++){
							runlistInfoObj.runlistRemarks.cols[i].optionValues.push($(options[j]).html());
						}
					}
					if(theOtherThings[i]!=''){
						runlistInfoObj.runlistRemarks.cols[i].name=theOtherThings[i];
					}
				}
				editList(runlistInfoObj,4);
			});
			if(allformatFilled){
				$(".lightboxable").find(".next").focus();
			}
		}
	});*/
}

function displayParOptions(par,idx){
	theBox.$content.find('.optionParameterOptions.'+idx).remove();
	par.after('<p class="optionParameterOptions '+idx+'"></p>')
	for (var i=0; i<runlistInfoObj.runlistRemarks.cols[idx]['optionValues'].length; i++){
		theBox.$content.find('.optionParameterOptions.'+idx).append('<button class="option '+i+' button pill icon remove danger">'+runlistInfoObj.runlistRemarks.cols[idx]['optionValues'][i]+'</button>');
	}
	theBox.$content.find('.optionParameterOptions.'+idx).find('.option').click(function(){
		var theIdx=Number($(this).prop('class').split(' ')[1]);
		runlistInfoObj.runlistRemarks.cols[idx]['optionValues'].splice(theIdx,1);
		$(this).remove();
		$.colorbox.resize();
	});
	$.colorbox.resize();
}

function submitRunlistData(listObj){
	listObj['dbname']=dbname;
	if(!listObj.isNewRunlist){
		if(listObj.isLinked){
			r=confirm('This runlist is linked. Information in DAQBroker will be replaced by the information in the linked list. Are you sure this is what you want to do?');
			listObj.isLinked=r;
		}
		$(".lightboxable").find(".finishPar").append('<img style="float: right;" class="loading" src="../images/loading.gif" height="42" width="42"></img>');
		$(".lightboxable").find(".finishPar").find('.error').remove();
		$(".lightboxable").find(".next").attr('disabled',true);
		var nowTime=new Date();
		listObj.clock=nowTime.getTime();
		$.ajax({
			url:"/runs/submitRunlistData",
			type: 'POST',
			dataType: "json",
			contentType: "application/json; charset=UTF-8",
			data : JSON.stringify(listObj),
			success: function(returned){
					$(".lightboxable").find(".loading").remove();
					$(".lightboxable").find(".next").attr('disabled',false);
					onGoingCreation=false;
					$.colorbox.close(true);
					globalUpdateOngoing=false;
					/*var n=new Noty({
						text      :  'Your run list was created successfully! This page will reload in 3 seconds or you can click here to speed up the process',
						theme     :  'relax',
						type      :  'success',
						timeout   :  3000,
						callbacks:{
							onClose: function(){
								
							}
						}
					}).show();*/
					location.reload();
			},
			error: function(returnedError){
				var n=new Noty({
					text      :  'There was a problem processing your request contact your network administrator and try again - '+JSON.stringify(returnedError),
					theme     :  'relax',
					type      :  'error',
					timeout   :  3000
				}).show();
			}
		});
	}
	else{
		$(".lightboxable").find(".finishPar").append('<img style="float: right;" class="loading" src="../images/loading.gif" height="42" width="42"></img>');
		$(".lightboxable").find(".finishPar").find('.error').remove();
		$(".lightboxable").find(".next").attr('disabled',true);
		$.ajax({
			url:"/runs/submitRunlistData",
			type: 'POST',
			dataType: "json",
			contentType: "application/json; charset=UTF-8",
			data : JSON.stringify(listObj),
			success: function(returned){
				$(".lightboxable").find(".loading").remove();
				$(".lightboxable").find(".next").attr('disabled',false);
				onGoingCreation=false;
				$.colorbox.close(true);
				globalUpdateOngoing=false;
				location.reload();//updateRuns();
			},
			error: function(returnedError){
				$(".lightboxable").find(".loading").remove();
				$(".lightboxable").find(".next").after('<span class="error" style="color:red;float:right;">There was a problem submitting your data. Refresh the page and retry.</span>');
				$(".lightboxable").find(".next").attr('disabled',false);
				$.colorbox.resize();
			}
		});
	}
}

function checkRuns(listObj,callback,callback2){
	$.ajax({
		url: '/runs/getRunList',
		type: 'POST',
		dataType: "json",
		data: {'database':dbname},
		success: function(returned){
			DAQBroRunsOld=returned;
			//Gotta put DAQBro rows in a universal format
			for (var i=0; i<DAQBroRunsOld.length; i++){
				DAQBroRunsOld[i]=DAQBroToRemoteRun(listObj,DAQBroRunsOld[i]);
			}
			var identifierIdx=[];
			var commentsIdx=[];
			var summaryIdx=[];
			var startDateIdx=[];
			var startDateFormatStr=''
			var endDateIdx=[];
			var endDateFormatStr='';
			for (var i=0; i<listObj.runlistRemarks.cols.length; i++){
				if(Number(listObj.runlistRemarks.cols[i].type)==3){//Found run identifier - can be more than one column
					identifierIdx.push(i);
				}
				if(Number(listObj.runlistRemarks.cols[i].type)==4){//Found comments - can be more than one column
					commentsIdx.push(i);
				}
				if(Number(listObj.runlistRemarks.cols[i].type)==5){//Found summary - can be more than one column
					summaryIdx.push(i);
				}
				if(Number(listObj.runlistRemarks.cols[i].type)==2){//Found end date describer - can be more than one column
					endDateIdx.push(i);
				}
				if(Number(listObj.runlistRemarks.cols[i].type)==1){//Found start date describer - can be more than one column
					startDateIdx.push(i);
				}
			}
			if(Number(listObj.runlistType)==0){//It's a user-made runlist only the locally stored values need analyzing
				for (var i=0; i<listObj.runlistRemarks.cols; i++){
					console.log('sdfsfdfsdfs');
				}
			}
			if(Number(listObj.runlistType)==1){//Google sheets import - need to get the data from Google first
				var gURL='https://script.google.com/macros/s/'+listObj.linkRemarks.scriptID+'/exec';
				var postData={
					'request'       : 'read',
					'spreadsheetID' : listObj.linkRemarks.spreadsheetID,
					'sheetID'       : listObj.linkRemarks.sheetID
				};
				$(".lightboxable").append('<img class="loading" src="../images/loading.gif" height="42" width="42"></img>');
				$.colorbox.resize();
				$.ajax({
					url: gURL,
					type: 'POST',
					dataType: "json",
					data : postData,
					//async: false,
					success: function(returned){
						//Gotta put remote rows in universal formatb - for that I have to use headerLine and filter out the empty header titles
						if(returned.error==0){
							remoteRunsOld=returned.data.values;
							var header=remoteRunsOld[Number(listObj.linkRemarks.headerLine)];
							for (var i=0; i<remoteRunsOld.length; i++){
								if(i>=Number(listObj.linkRemarks.headerLine)){
									remoteRunsOld[i]=remoteRowFilter(remoteRunsOld[i],header,listObj);
								}
							}
							remoteRunsNew=[];
							var remoteLastUpdate=new Date(returned.lastUDate);
							var firstLoop=[];
							var secondLoop=[];
							var idxRemote='i';
							var paralel=false;
							if(listObj.isLinked){
								if(Number(listObj.lastUpdate)>remoteLastUpdate.getTime()){//DAQBroker has the most recent update
									var remoteHeaderLine=remoteRunsOld[Number(listObj.linkRemarks.headerLine)];
									var mustUpdate=false;
									var foundOldColLog=Array.apply(null, Array(remoteHeaderLine.length)).map(Number.prototype.valueOf,0);
									var newCols=[];
									listObj.runlistRemarks.noHeaderCols=0;
									for (var j=0; j<listObj.runlistRemarks.cols.length; j++){
										var found=false;
										var colNameDAQBro=listObj.runlistRemarks.cols[j].name;
										for (var i=0; i<remoteHeaderLine.length; i++){
											var colNameRemote=remoteHeaderLine[i];
											if(colNameRemote==colNameDAQBro || colNameRemote==listObj.runlistRemarks.cols[j].nameOriginal){
												found=true
												foundOldColLog[j]=1;
												break;
											}
										}
										if(found){
											listObj.runlistRemarks.cols[j]['action']='noChange';
											newCols.push(listObj.runlistRemarks.cols[j]);//Column didn't change
											listObj.runlistRemarks.noHeaderCols=listObj.runlistRemarks.noHeaderCols+1;
										}
										else{
											mustUpdate=true;
											newCols.push({'nameOriginal'  :  colNameRemote , 'name'  :  colNameRemote , 'type'  :  0 , 'action' : 'add'});
											listObj.runlistRemarks.noHeaderCols=listObj.runlistRemarks.noHeaderCols+1;
										}
									}
									for (var j=0; j<listObj.runlistRemarks.cols.length; j++){
										if(foundOldColLog[j]==0){
											mustUpdate=true;
											listObj.runlistRemarks.cols[j]['action']='delete';
											newCols.push(listObj.runlistRemarks.cols[j]);
										}
									}
									if(mustUpdate){
										console.log('MUST UPDATE DAQBro COLUMNS TO GOOGLE!');
									}
									else{
										DAQBroRunsNew=DAQBroRunsOld;
										remoteChangeRows(listObj, DAQBroRunsNew, remoteRunsOld, header, callback,callback2, identifierIdx, startDateIdx, endDateIdx, summaryIdx, commentsIdx, startDateFormatStr, endDateFormatStr);
									}//Should be else. Updating columns should trigger a new table update request which leads to new row insertion
									
									
								}
								else if(Number(listObj.lastUpdate)<remoteLastUpdate.getTime()){//Google sheets has the most recent update
									//First need to check if columns are missing/added and make those changes "locally"
									var remoteHeaderLine=remoteRunsOld[Number(listObj.linkRemarks.headerLine)];
									var mustUpdate=false;
									var foundOldColLog=Array.apply(null, Array(listObj.runlistRemarks.cols.length)).map(Number.prototype.valueOf,0);
									var newCols=[];
									listObj.runlistRemarks.noHeaderCols=0;
									for (var i=0; i<remoteHeaderLine.length; i++){
										var found=false;
										var colNameRemote=remoteHeaderLine[i];
										for (var j=0; j<listObj.runlistRemarks.cols.length; j++){
											var colNameDAQBro=listObj.runlistRemarks.cols[j].name;
											if(colNameRemote==colNameDAQBro || colNameRemote==listObj.runlistRemarks.cols[j].nameOriginal){
												found=true
												foundOldColLog[j]=1;
												break;
											}
										}
										if(found){
											listObj.runlistRemarks.cols[j]['action']='noChange';
											newCols.push(listObj.runlistRemarks.cols[j]);//Column didn't change
											listObj.runlistRemarks.noHeaderCols=listObj.runlistRemarks.noHeaderCols+1;
										}
										else{
											mustUpdate=true;
											newCols.push({'nameOriginal'  :  colNameRemote , 'name'  :  colNameRemote , 'type'  :  0 , 'action' : 'add'});
											listObj.runlistRemarks.noHeaderCols=listObj.runlistRemarks.noHeaderCols+1;
										}
									}
									for (var j=0; j<listObj.runlistRemarks.cols.length; j++){
										if(foundOldColLog[j]==0){
											mustUpdate=true;
											listObj.runlistRemarks.cols[j]['action']='delete';
											newCols.push(listObj.runlistRemarks.cols[j]);
										}
									}
									if(mustUpdate){
										listObj.runlistRemarks.cols=newCols
										listObj.runlistRemarks.noHeaderCols=newCols.length;
										listObj.clock=String(remoteLastUpdate);
										editList(listObj,3);
										$(".lightboxable").find('.next').before('<p style="background-color:#fcf8e3;color:#8a6d3b">Remote table columns were changed, please review the new columns and make sure their format is correct</p>');
										$.colorbox.resize();
									}
									else{
										DAQBroChangeRow(listObj,identifierIdx,startDateIdx,endDateIdx, summaryIdx, commentsIdx, startDateFormatStr,endDateFormatStr,remoteLastUpdate,callback,callback2);
									}
								}
								else{
									callback();
									if(!(typeof callback2==='undefined')){
										callback2();
									}
								}
							}
							else{
								callback();
								if(!(typeof callback2==='undefined')){
									callback2();
								}
							}
						}
					},
					error: function(returnedError){
						remoteRunsOld=[];
						callback();
						if(!(typeof callback2==='undefined')){
							callback2();
						}
					}
				});
			}
			else{//Something else, what?
				callback();
				if(!(typeof callback2==='undefined')){
					callback2();
				}
			}
		},
		error: function(){
			callback();
			if(!(typeof callback2==='undefined')){
				callback2();
			}
		}
	});
}

function DAQBroChangeRow(listObj,identifierIdx,startDateIdx,endDateIdx,summaryIdx, commentsIdx ,startDateFormatStr,endDateFormatStr,remoteLastUpdate,callback,callback2){
	$("#errorLocalDiv").empty();
	$(".expandErrorsLocal").empty();
	var remoteUnique='';
	DAQBroRunsNew=[];
	remoteRunsNew=remoteRunsOld;
	var foundLog=Array.apply(null, Array(DAQBroRunsOld.length)).map(Number.prototype.valueOf,0);
	for (var i=0; i<remoteRunsOld.length; i++){
		if(i>Number(listObj.linkRemarks.headerLine)){
			var found=false;
			var temp=[];
			for (var j=0; j<identifierIdx.length; j++){
				temp.push(String(remoteRunsOld[i][identifierIdx[j]]));
			}
			remoteUnique=temp.join(' ');
			var DAQBroUnique='';
			for (var j=0; j<DAQBroRunsOld.length; j++){
				var temp=[];
				for (var k=0; k<identifierIdx.length; k++){
					temp.push(DAQBroRunsOld[j][identifierIdx[k]]);
				}
				DAQBroUnique=temp.join(' ');
				if(DAQBroUnique==remoteUnique){
					found=true;
					break;
				}
			}
			var action='';
			if(found){
				var allSame=true;
				for (var k=0; k<remoteRunsOld[i].length; k++){
					if(String(remoteRunsOld[i][k])!=DAQBroRunsOld[j][k]){
						allSame=false;
						break
					}
				}
				if(allSame){
					action='donothing';
				}
				else{
					action='change';
				}
				if(foundLog[j]==0){
					foundLog[j]=1;
				}
				else{
					$("#errorLocalDiv").empty();
					$("#errorLocalDiv").append('Some changes could not be inserted, <a class="expandErrorsLocalShow">click here</a> for an explanation.');
					$(".expandErrorsLocal").append('<p>'+i+'. Row:'+JSON.stringify(remoteRunsOld[i])+' | There is already a run with the same unique identifier!</p>');
					$(".expandErrorsLocal").find('.title').remove();
					$(".expandErrorsLocal").prepend('<h3 class="title">Errors found</h3>');
					$(".expandErrorsLocalShow").click(function(){
						$.colorbox({
							inline:true,
							href:$(".expandErrorsLocal"),
							onOpen:function(){
								$(".expandErrorsLocal-outer").show();
							},
							onCleanup:function(){
								$(".expandErrorsLocal-outer").hide();
								updateRuns();
							},
							width:"75%",
							maxWidth: "1000px",
							closeButton	:false
						});
					});
				}
			}
			else{
				action='add';
			}
			DAQBroRunsNew.push({'run'  :  remoteRunsOld[i] , 'action' : action});
		}
	}
	for (var j=0; j<DAQBroRunsOld.length; j++){
		if(foundLog[j]==0){
			DAQBroRunsNew.push({'run'  :  DAQBroRunsOld[j] , 'action' : 'delete'});
		}
	}
	//DAQBroRunsNew has the most recent runs and they should be sent to the database
	var insertData={
		'rows'  :  DAQBroRunsNew,
		'date'  :  String(remoteLastUpdate.getTime()),
		'dbname': dbname
	};
	$.ajax({
		url: 'insertRuns.php',
		type: 'POST',
		dataType: "json",
		data : insertData,
		//async: false,
		success: function(returned){
			$("#errorDiv").empty();
			$(".expandErrors").empty();
			var errorsFound=false;
			for (var i=0; i<returned.errorRows.length; i++){
				if(returned.errorRows[i]==1){
					if(!errorsFound){
						$("#errorDiv").append('Some changes could not be inserted, <a class="expandErrorsShow">click here</a> for an explanation.');
						errorsFound=true;
					}
					$(".expandErrors").append('<p>'+i+'. Row:'+JSON.stringify(returned.runs[i])+' | Error: '+returned.errorStrRows[i]+' | MySQL error: '+returned.errorMsgRows[i]+'</p>');
				}
			}
			$(".expandErrorsShow").click(function(){
				$.colorbox({
					inline:true,
					href:$(".expandErrors"),
					onOpen:function(){
						$(".expandErrors-outer").show();
					},
					onCleanup:function(){
						$(".expandErrors-outer").hide();
						updateRuns();
					},
					width:"75%",
					maxWidth: "1000px",
					closeButton	:false
				});
			});
			callback();
			if(!(typeof callback2==='undefined')){
				callback2();
			}
		},
		error: function(returned){
			callback();
			if(!(typeof callback2==='undefined')){
				callback2();
			}
		}
	});
}

function DAQBroToRemoteRun(listObj,row){
	var returnRow=[];
	if(listObj.runlistType=="1"){//Google Sheets list type
		var uniquesIdx=0;
		var uniquesCommIdx=0;
		var uniquesSummIdx=0;
		var uniques=row['run'].split('.');
		/*if(row['comments']!=null){
			var comments=row['comments'].split('|');
		}
		else{
			var comments=[];
		}
		if(row['comments']!=null){
			var comments=row['comments'].split('|');
		}
		else{
			var comments=[];
		}
		var summary=row['summary'].split('|');*/
		for (var i=0; i<listObj.runlistRemarks.cols.length; i++){
			var col=listObj.runlistRemarks.cols[i];
			//console.log(uniques);
			if(col.type==1 || col.type==2){//start time or end time must make ajax request
				var name='';
				if(col.type==1){
					name='start';
				}
				else{
					name=col.name;
				}
				var postData={
					'format'  : col.format,
					'idx'     : i,
					'dateStr' : row[name],
					'dbname'  : dbname
				};
				$.ajax({
					url: 'convertTimeFormat.php',
					type: 'POST',
					dataType: "json",
					data : postData,
					async: false,
					success: function(returned){
						returnRow[returned.idx]=returned.formattedStr;
					},
					error: function(returned){
						returnRow[returned.idx]='N/A';
					}
				});
			}
			else if(col.type==3){
				returnRow[i]=uniques[uniquesIdx];
				uniquesIdx=uniquesIdx+1;
			}
			else if(col.type==5){
				returnRow[i]=summary[uniquesSummIdx];
				uniquesSummIdx=uniquesSummIdx+1;
			}
			else{
				returnRow[i]=row[col.name];
			}
		}
	}
	else if(listObj.runlistType=="0"){//Google Sheets list type
		returnRow=row;
		delete returnRow.alter;
		/*var uniquesIdx=0;
		var uniquesCommIdx=0;
		var uniquesSummIdx=0;
		var uniques=row['run'].split('.');
		for (var i=0; i<listObj.runlistRemarks.cols.length; i++){
			var col=listObj.runlistRemarks.cols[i];
			//console.log(uniques);
			if(col.type==1 || col.type==2){//start time or end time must make ajax request
				var name='';
				if(col.type==1){
					name='start';
				}
				else{
					name=col.name;
				}
				var postData={
					'format'  : col.format,
					'idx'     : i,
					'dateStr' : row[name],
					'dbname'  : dbname
				};
				$.ajax({
					url: 'convertTimeFormat.php',
					type: 'POST',
					dataType: "json",
					data : postData,
					async: false,
					success: function(returned){
						returnRow[returned.idx]=returned.formattedStr;
					},
					error: function(returned){
						returnRow[returned.idx]='N/A';
					}
				});
			}
			else if(col.type==3){
				returnRow[i]=uniques[uniquesIdx];
				uniquesIdx=uniquesIdx+1;
			}
			else if(col.type==5){
				returnRow[i]=summary[uniquesSummIdx];
				uniquesSummIdx=uniquesSummIdx+1;
			}
			else{
				returnRow[i]=row[col.name];
			}
		}
		console.log('not google');
	}*/
	}
	//console.log(returnRow);
	return returnRow;
}

function remoteChangeRows(listObj, DAQBroRunsNew, remoteRunsOld, header, callback,callback2 , identifierIdx,summaryIdx, commentsIdx,startDateIdx,endDateIdx,startDateFormatStr,endDateFormatStr){
	if(listObj.runlistType=="1"){//Google Sheets list type
		$("#errorLocalDiv").empty();
		$(".expandErrorsLocal").empty();
		remoteRunsNew=[];
		var foundLog=Array.apply(null, Array(remoteRunsOld.length)).map(Number.prototype.valueOf,0);
		for (var i=0; i<DAQBroRunsNew.length; i++){
			var found=false;
			var temp=[];
			for (var j=0; j<identifierIdx.length; j++){
				temp.push(String(DAQBroRunsNew[i][identifierIdx[j]]));
			}
			var DAQBroUnique=temp.join(' ');
			for (var j=Number(listObj.linkRemarks.headerLine)+1; j<remoteRunsOld.length; j++){
				var temp=[];
				for (var k=0; k<identifierIdx.length; k++){
					temp.push(String(remoteRunsOld[j][identifierIdx[k]]));
				}
				var remoteUnique=temp.join(' ');
				if(DAQBroUnique==remoteUnique){
					found=true;
					break;
				}
			}
			var action='';
			if(found){
				var allSame=true;
				for (var k=0; k<remoteRunsOld[i].length; k++){
					if(String(remoteRunsOld[j][k])!=DAQBroRunsOld[i][k]){
						allSame=false;
						break
					}
				}
				if(allSame){
					action='donothing';
				}
				else{
					action='editRow';
				}
				if(foundLog[j]==0){
					foundLog[j]=1;
				}
			}
			else{
				action='addRow';
			}
			remoteRunsNew.push({'request' : action ,'spreadsheetID' : listObj.linkRemarks.spreadsheetID, 'sheetID' : listObj.linkRemarks.sheetID , 'rowNumber' : j , 'rowData' : JSON.stringify(remoteRunPadding(DAQBroRunsNew[i],header))});
		}
		for (var j=Number(listObj.linkRemarks.headerLine)+1; j<remoteRunsOld.length; j++){
			if(foundLog[j]==0){
				remoteRunsNew.push({'request' : 'deleteRow' ,'spreadsheetID' : listObj.linkRemarks.spreadsheetID, 'sheetID' : listObj.linkRemarks.sheetID , 'rowIndex' : j , 'rowData' : JSON.stringify(remoteRunPadding(remoteRunsOld[j],header))});
			}
		}
		var ajaxes=[];
		var returns=[];
		gURL='https://script.google.com/macros/s/'+listObj.linkRemarks.scriptID+'/exec';
		for (var j=0; j<remoteRunsNew.length; j++){
			if(remoteRunsNew[j].request!='donothing' && remoteRunsNew[j].request!='deleteRow'){
				ajaxes.push(
					$.ajax({
						url: gURL,
						type: 'POST',
						dataType: "json",
						data : remoteRunsNew[j],
						success: function(returned){
							returns.push(returned);
						}
					})
				);
			}
		}
		var defer=$.when.apply($, ajaxes);
		defer.done(function(args){
			/*for (var j=0; j<args.length; j++){
				console.log(args[j]);
			}*/
			var ajaxesDel=[];
			for (var j=0; j<remoteRunsNew.length; j++){
				if(remoteRunsNew[j].request=='deleteRow'){
					ajaxes.push(
						$.ajax({
							url: gURL,
							type: 'POST',
							dataType: "json",
							data : remoteRunsNew[j],
							success: function(returned){
								returns.push(returned);
							}
						})
					);
				}
			}
			callback();
			if(!(typeof callback2==='undefined')){
				callback2();
			}
		});

	}
	else{
		console.log('not google');
	}
}

function remoteRunPadding(row, headerLineRaw){
	/*var leftIdx=0;
	var rightIdx=0;
	var startCountingRight=false;
	var startCountingLeft=true;
	var intermediate=[];
	for (var i=0; i<headerLineRaw.length; i++){
		if(startCountingLeft){
			if(headerLineRaw[i]!=''){
				startCountingLeft=false;
				startCountingRight=true;
			}
			else{
				leftIdx=i;
			}
		}
		if(startCountingRight){
			if(headerLineRaw[i]!=''){
				rightIdx=i;
			}
			else{
				intermediate.push(i);
			}
		}
	}
	intermediate=intermediate.filter(function(el){
		return el<rightIdx;
	})
	console.log(leftIdx);*/
	//console.log(row);
	//console.log(headerLineRaw);
	var rowIdx=0;
	var returnRow=[];
	for (var i=0; i<headerLineRaw.length; i++){
		if(headerLineRaw[i]!=''){
			returnRow.push(row[rowIdx]);
			rowIdx=rowIdx+1;
		}
		else{
			returnRow.push('');
		}
	}
	return returnRow;
}

function remoteRowFilter(row,headerLine,listObj){
	var returnRow=[];
	if(listObj.runlistType=="1"){//Google Sheets list type
		returnRow=row.filter(function(el){
			elIdx=row.indexOf(el);
			return headerLine[elIdx].length>0;
		});
	}
	return returnRow
}

function showTable(){
	$.ajax({
		url: '/runs/getRunList',
		type: 'POST',
		dataType: "json",
		data: {'database':dbname},
		success: function(returned){
			if(firstTime){//Must build table
				currentRuns=returned;
				setButtons();
				var tableCols=[];
				var tableColsDef=[];
				var order
				var orderingIdx=[];
				var dateIdx=[];
				var startDatePushed=false;
				var endDatePushed=false;
				var uniquePushed=false;
				var uniqueIdx=[];
				var theOrder=[[1,'desc']];
				var theRunIdx=0;
				var theStartTimeIdx=0;
				var parIdx=0;
				var activeLine=[];
				tableCols.push({data: 'run',"name":'run',"title":'run',"width":"60px",'idx':0});
				tableCols.push({data: 'start',"name":'start',"title":'start',"width":"60px",'idx':1});
				tableCols.push({data: 'end',"name":'end',"title":'end',"width":"60px",'idx':2});
				runlistInfoObj.runlistRemarks.cols.forEach(function(el){
					if(Number(el.type)!=3 && Number(el.type)!=2 && Number(el.type)!=1){
						//tableCols.push({data:el.name,"name":el.name,"title":el.name,"width":(100/runlistInfoObj.runlistRemarks.cols.length)+"%",'idx':9});
						if(el.type=="0"){
							if(el.parType=="0"){
								var theName=el.name + '('+el.parUnits+')';
							}
							else{
								var theName=el.name;
							}
						}
						else{
							var theName=el.name;
						}
						tableCols.push({data:el.name,"name":theName,"title":theName,"width":"60px",'idx':(3+parIdx)});
						tableColsDef.push({"width":"60px"});
						theOrder.push([(2+parIdx),'desc']);
						parIdx=parIdx+1;
					}
					if(Number(el.type)==1 || Number(el.type)==2){
						dateIdx.push(el.name);
					}
				});
				tableCols.push({data:"alter","name":"alter",'idx':66776});
				tableColsDef.push({"width":"50px"});
				tableCols.sort(compareTableCols);
				if(tableCols.length>=15){
					theScroll=true;
				}
				else{
					theScroll=false;
				}
				var allLines=[];
				var allActiveLines=[];
				for (var i=0; i<returned.length; i++){
					var line={};
					runKeys=Object.keys(returned[i]);
					if(returned[i]['active']!='1'){
						for (var j=0; j<runKeys.length; j++){
							if(runKeys[j]!='active'){
								dateIdx=['start','end'];
								if(dateIdx.indexOf(runKeys[j])>=0){
									var date=new Date(Number(returned[i][runKeys[j]]));
									line[runKeys[j]]=moment.utc(date.getTime()).format('YYYY/MM/DD HH:mm:ss');
								}
								else{
									if(returned[i][runKeys[j]]){
										line[runKeys[j]]=returned[i][runKeys[j]];
									}
									else{
										line[runKeys[j]]="N/A"
									}
								}
							}
						}
						if(currentType=="1" ||currentType=="3"){
							line['alter']='<p><button class="commentsAdd '+i+' button pill huge icon comment"></button></p><p><button class="editRun '+i+' button pill huge icon edit"></button> <button class="delete '+i+' button pill huge icon danger remove"></button></p>';
						}
						else{
							line['alter']='<button class="commentsAdd '+i+' button pill huge icon comment"></button>';
						}
						allLines.push(line);
					}
					else if(returned[i]['active']=='1'){
						runKeys=Object.keys(returned[i]);
						var activeLine={};
						var uniqueStr=[];
						for (var j=0; j<runKeys.length; j++){
							if(runKeys[j]!='active'){
								for (var k=0; k<runlistInfoObj.runlistRemarks.cols.length; k++){
									var col=runlistInfoObj.runlistRemarks.cols[k];
									if(col.name==runKeys[j]){
										if(Number(col.type)==1){
											var date=new Date(Number(returned[i][runKeys[j]]));
											activeLine[runKeys[j]]=moment.utc(date.getTime()).format('YYYY/MM/DD HH:mm:ss')
											break;
										}
										else if(Number(col.type)==2){
											var date=new Date(Number(returned[i][runKeys[j]]));
											activeLine[runKeys[j]]='<span class="endTimeActiveUpdate">'+moment.utc(date.getTime()).format('YYYY/MM/DD HH:mm:ss')+'</span>';
											break;
										}
										else{
											if(returned[i][runKeys[j]]){
												activeLine[runKeys[j]]=returned[i][runKeys[j]];
											}
											else{
												activeLine[runKeys[j]]="N/A"
											}
											break;
										}
									}
									else if(runKeys[j]=='start'){
										var date=new Date(Number(returned[i][runKeys[j]]));
										activeLine[runKeys[j]]=moment.utc(date.getTime()).format('YYYY/MM/DD HH:mm:ss');
										break;
									}
									else if(runKeys[j]=='end'){
										var date=new Date();
										activeLine[runKeys[j]]='<span class="endTimeActiveUpdate">'+moment.utc(date.getTime()).format('YYYY/MM/DD HH:mm:ss')+'</span>';
										break;
									}
									else if(runKeys[j]=='run'){
										activeLine[runKeys[j]]=returned[i][runKeys[j]];
										break;
									}
								}
							}
						}
						activeLine['run']=returned[i]['run'];
						if(currentType=="1" || currentType=="3"){
							activeLine['alter']='<p><button class="commentsAdd '+i+' button pill huge icon comment"></button> </p><p><button class="editRun '+i+' button pill huge icon edit"></button> <button class="delete '+i+' button pill huge icon danger remove"></button></p>';
						}
						else{
							activeLine['alter']='<button class="commentsAdd '+i+' button pill huge icon comment"></button>';
						}
						allActiveLines.push(activeLine);
					}
				}
				$.fn.dataTable.moment( 'DD/MM/YYYY HH:mm:ss' );
				$.fn.dataTable.moment( 'YYYY/MM/DD HH:mm:ss' );
				runTableActive=$('#activeRunTable').DataTable({
					columns: tableCols,
					"order": theOrder,
					"oLanguage": {
						"sEmptyTable":     "No active run found, make one!"
					},
					'data': allActiveLines,
					scrollX:theScroll,
					scrollCollapse: true,
					"columnDefs": [
						{"className": "dt-center", "targets": "_all"}
					],
					"deferRender": true,
					fixedColumns: {
						leftColumns: 3,
						rightColumns: 1
					}
				});
				$.fn.dataTable.moment( 'DD/MM/YYYY HH:mm:ss' );
				$.fn.dataTable.moment( 'YYYY/MM/DD HH:mm:ss' );
				runTable=$('#runlistTable').DataTable({
					"columns": tableCols,
					"columnDefs":tableColsDef,
					"order": theOrder,
					"pageLength": 5,
					scrollX:theScroll,
					scrollCollapse: true,
					"deferRender": true,
					'data':allLines,
					fixedColumns: {
						leftColumns: 3,
						rightColumns: 1
					}
				}).draw();
				$('#runlistTable tbody').on( 'click', '.editRun' , function () {
					var element=$(this);
					var runNumber=currentRuns[Number(element.prop('class').split(" ")[1])]["run"];
					setupEditButton(element,runTable,runNumber,false);
				});
				$('#runlistTable tbody').on( 'click', '.delete' , function () {
					var element=$(this);
					setupDeleteButton(element);
				});
				$('#runlistTable tbody').on( 'click', '.commentsAdd' , function () {
					var element=$(this);
					var runNumber=currentRuns[Number(element.prop('class').split(" ")[1])]["run"];
					setupComments(element,runTable,runNumber,false);
				});
					
				runTable.order(orderingIdx).draw();
				runTable.page.len(5).draw();
				runTableActive.order(orderingIdx).draw();
				runTableActive.rows().every( function ( rowIdx, tableLoop, rowLoop ){
					var data = $(this.node());
					if(currentType=="1" || currentType=="3"){
						data.find('.editRun').click(function(){
							console.log('HERE SETUP EDIT');
							var element=$(this);
							var runNumber=$(data.find('td')[0]).html();
							setupEditButton(element,runTableActive,runNumber,true);
						});
						data.find('.delete').click(function(){
							var element=$(this);
							setupDeleteButton(element);
						})
					}
					else{
						data.find('.editRun').prop('disabled',true);
						data.find('.delete').prop('disabled',true);
					}
					data.find('.commentsAdd').click(function(){
						var element=$(this);
						var runNumber=$(data.find('td')[0]).html();
						setupComments(element,runTableActive,runNumber,true);
					});
				});
				firstTime=false;
			}
			else{//Must only update table
				currentRuns=returned;
				setButtons();
				var tableCols=[];
				var tableColsDef=[];
				var order
				var orderingIdx=[];
				var dateIdx=[];
				var startDatePushed=false;
				var endDatePushed=false;
				var uniquePushed=false;
				var uniqueIdx=[];
				var theRunIdx=0;
				var theStartTimeIdx=0;
				var theOrder=[[1,'desc']];
				var parIdx=0;
				runTable.destroy();
				$("#runlistTable").empty();
				runTableActive.destroy();
				$("#activeRunTable").empty();
				tableCols.push({data: 'run',"name":'run',"title":'run',"width":"60px",'idx':0});
				tableCols.push({data: 'start',"name":'start',"title":'start',"width":"60px",'idx':1});
				tableCols.push({data: 'end',"name":'end',"title":'end',"width":"60px",'idx':2});
				runlistInfoObj.runlistRemarks.cols.forEach(function(el){
					if(Number(el.type)!=3 && Number(el.type)!=2 && Number(el.type)!=1){
						if(el.type=="0"){
							if(el.parType=="0"){
								var theName=el.name + '('+el.parUnits+')';
							}
							else{
								var theName=el.name;
							}
						}
						else{
							var theName=el.name;
						}
						tableCols.push({data:el.name,"name":theName,"title":theName,"width":"60px",'idx':(3+parIdx)});
						tableColsDef.push({"width":"60px"});
						theOrder.push([(2+parIdx),'desc']);
						parIdx=parIdx+1;
					}
					if(Number(el.type)==1 || Number(el.type)==2){
						dateIdx.push(el.name);
					}
				});
				tableCols.push({data:"alter","name":"alter",'idx':66776});
				tableColsDef.push({"width":"60px"});
				if(endDatePushed){
					var fixedCols=3;
				}
				else{
					var fixedCols=2;
				}
				tableCols.sort(compareTableCols);
				if(tableCols.length>=15){
					theScroll=true;
				}
				else{
					theScroll=false;
				}
				var allLines=[];
				var activeLines=[];
				for (var i=0; i<returned.length; i++){
					var line={};
					runKeys=Object.keys(returned[i]);
					if(returned[i]['active']!='1'){
						for (var j=0; j<runKeys.length; j++){
							dateIdx=['start','end'];
							if(dateIdx.indexOf(runKeys[j])>=0){
								var date=new Date(Number(returned[i][runKeys[j]]));
								line[runKeys[j]]=moment.utc(date.getTime()).format('YYYY/MM/DD HH:mm:ss');
							}
							else{
								if(returned[i][runKeys[j]]){
									line[runKeys[j]]=returned[i][runKeys[j]];
								}
								else{
									line[runKeys[j]]="N/A"
								}
							}
						}
						if(currentType=="1" || currentType=="3"){
							line['alter']='<p><button class="commentsAdd '+i+' button pill huge icon comment"></button> </p><p><button class="editRun '+i+' button pill huge icon edit"></button> <button class="delete '+i+' button pill huge icon danger remove"></button></p>';
						}
						else{
							line['alter']='<button class="commentsAdd '+i+' button pill huge icon comment">';
						}
						allLines.push(line);
					}
					if(returned[i]['active']=='1'){
						runKeys=Object.keys(returned[i]);
						var activeLine={};
						var uniqueStr=[];
						for (var j=0; j<runKeys.length; j++){
							if(runKeys[j]!='active'){
								activeLine[runKeys[j]]=returned[i][runKeys[j]];
								for (var k=0; k<runlistInfoObj.runlistRemarks.cols.length; k++){
									var col=runlistInfoObj.runlistRemarks.cols[k];
									if(col.name==runKeys[j]){
										if(Number(col.type)==1){
											var date=new Date(Number(returned[i][runKeys[j]]));
											activeLine['start']=moment.utc(date.getTime()).format('YYYY/MM/DD HH:mm:ss');
											break;
										}
										else if(Number(col.type)==2){
											var date=new Date(Number(returned[i][runKeys[j]]));
											activeLine['end']='<span class="endTimeActiveUpdate">'+moment.utc(date.getTime()).format('YYYY/MM/DD HH:mm:ss')+'</span>';
											break;
										}
										else{
											if(returned[i][runKeys[j]]){
												activeLine[runKeys[j]]=returned[i][runKeys[j]];
											}
											else{
												activeLine[runKeys[j]]="N/A"
											}
											break;
										}
									}
									else if(runKeys[j]=='start'){
										var date=new Date(Number(returned[i][runKeys[j]]));
										activeLine[runKeys[j]]=moment.utc(date.getTime()).format('YYYY/MM/DD HH:mm:ss');
										break;
									}
									else if(runKeys[j]=='end'){
										var date=new Date();
										activeLine[runKeys[j]]='<span class="endTimeActiveUpdate">'+moment.utc(date.getTime()).format('YYYY/MM/DD HH:mm:ss')+'</span>';
										break;
									}
									else if(runKeys[j]=='run'){
										activeLine[runKeys[j]]=returned[i][runKeys[j]];
										break;
									}
								}
							}
						}
						activeLine['run']=returned[i]['run'];
						if(currentType=="1" || currentType=="3"){
							activeLine['alter']='<p><button class="commentsAdd '+i+' button pill huge icon comment"></button> </p><p><button class="editRun '+i+' button pill huge icon edit"></button> <button class="delete '+i+' button pill huge icon danger remove"></button></p>';
						}
						else{
							activeLine['alter']='<button class="commentsAdd '+i+' button pill huge icon comment"></button>';
						}
						activeLines.push(activeLine);
						//var newRow=runTableActive.row.add(activeLine).draw(false);
					}
				}
				$.fn.dataTable.moment( 'DD/MM/YYYY HH:mm:ss' );
				$.fn.dataTable.moment( 'YYYY/MM/DD HH:mm:ss' );
				runTableActive=$('#activeRunTable').DataTable({
					columns: tableCols,
					"columnDefs":tableColsDef,
					//"order": theOrder,
					"oLanguage": {
						"sEmptyTable":     "No active runs found, make one!"
					},
					fixedColumns: {
						leftColumns: 3,
						rightColumns: 1
					},
					'scrollX':theScroll,
					scrollCollapse: true,
					"deferRender": true,
					'data' : activeLines
				});
				$.fn.dataTable.moment( 'DD/MM/YYYY HH:mm:ss' );
				$.fn.dataTable.moment( 'YYYY/MM/DD HH:mm:ss' );
				runTable=$('#runlistTable').DataTable({
					
					columns: tableCols,
					"columnDefs":tableColsDef,
					//"order": theOrder,
					"pageLength": 5,
					fixedColumns: {
						leftColumns: 3,
						rightColumns: 1
					},
					'scrollX':theScroll,
					scrollCollapse: true,
					'bSortClasses':false,
					"deferRender": true,
					'data':allLines
				});
				runTable.order(orderingIdx).draw();
				runTableActive.order(orderingIdx).draw();
				runTable.draw();
				runTable.page.len(5).draw();
				runTableActive.draw();
				$('#runlistTable tbody').on( 'click', '.editRun' , function () {
					var element=$(this);
					var runNumber=currentRuns[Number(element.prop('class').split(" ")[1])]["run"];
					setupEditButton(element,runTable,runNumber,false);
				});
				$('#runlistTable tbody').on( 'click', '.delete' , function () {
					var element=$(this);
					setupDeleteButton(element);
				});
				$('#runlistTable tbody').on( 'click', '.commentsAdd' , function () {
					var element=$(this);
					var runNumber=currentRuns[Number(element.prop('class').split(" ")[1])]["run"];
					setupComments(element,runTable,runNumber,false);
				});
				runTableActive.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
					var data = $(this.node());
					if(currentType=="1" || currentType=="3"){
						data.find('.editRun').click(function(){
							var element=$(this);
							var runNumber=$(data.find('td')[0]).html();
							setupEditButton(element,runTableActive,runNumber,true);
						});
						data.find('.delete').click(function(){
							var element=$(this);
							setupDeleteButton(element);
						})
					}
					else{
						data.find('.editRun').prop('disabled',true);
						data.find('.delete').prop('disabled',true);
					}
					data.find('.commentsAdd').click(function(){
						var element=$(this);
						var runNumber=$(data.find('td')[0]).html();
						setupComments(element,runTableActive,runNumber,true);
					});
				});
			}
			updateGlobal();;
			runTableActive.fixedColumns().update();
			runTable.fixedColumns().update();
		},
		error: function(returned){
			//$(".display").show();
			//$(".loading").hide();
			updateGlobal();
		}
	});
}

var timeHidden=0;

window.setInterval(function(){
	if(!document.hidden){
		var update=new Date();
		$("#activeRunTable").find('.endTimeActiveUpdate').html(moment.utc(update.getTime()).format('YYYY/MM/DD HH:mm:ss'));
		var datePickerFormat=moment.utc(update.getTime()).format('D/M/YYYY H:m:s')
		if(document.querySelector('.activeTimeRunInsert')!=null){
			document.querySelector('.activeTimeRunInsert')._flatpickr.setDate(update.getTime()+update.getTimezoneOffset()*1000*60);
		}
		if(document.querySelector('.runCommentDateActive')!=null){
			document.querySelector('.runCommentDateActive')._flatpickr.setDate(update.getTime()+update.getTimezoneOffset()*1000*60);
		}
		if(!activeCommentPresesd){
			runTableActive.fixedColumns().update();
		}
	}
}, 1000);


function setupDeleteButton(element){
	runIdx=Number(element.attr('class').split(' ')[1]);
	//var runDelete=DAQBroToRemoteRun(runlistInfoObj,currentRuns[runIdx]);
	var runDelete=currentRuns[runIdx];
	var newDate=new Date();
	var insertData={
		'rows'  :  [{'run'  :  runDelete , 'action' : 'delete'}],
		'date'  :  String(newDate.getTime()),
		'dbname': dbname
	};
	onGoingCreation=true;
	r=confirm('Are you sure you want to delete this run?');
	if(r){
		$.ajax({
			url: '/runs/insertRun',
			type: 'POST',
			dataType: "json",
			contentType: "application/json; charset=UTF-8",
			data : JSON.stringify(insertData),
			success: function(returned){
				$("#errorDiv").empty();
				$(".expandErrors").empty();
				updateRuns();
			},
			error: function(returned){
				alert('There was an error handling your request');
			}
		});
	}
	else{
		onGoingCreation=false;
	}
}

function decodeHtml(html) {
    var txt = document.createElement("textarea");
    txt.innerHTML = html;
    return txt.value;
}


function setupComments(element,table,runNumber,active){
	runIdx=Number(element.attr('class').split(' ')[1]);
	//var runEdit=DAQBroToRemoteRun(runlistInfoObj, currentRuns[runIdx]);
	var runEdit=currentRuns[runIdx];
	var newDataLine={};
	var foundEndTime=false;
	var formatStart='';
	var formatEnd='';
	if(currentRuns[runIdx]['comments']=='' || currentRuns[runIdx]['comments']==null || currentRuns[runIdx]['comments']=='null'){
		currentRuns[runIdx]['comments']='[]';
	}
	var comments=JSON.parse(currentRuns[runIdx]['comments']);
	var childText='<p style="font-size:125%">Summary: <span class="lookAtMeComments" tabindex="1" style="font-style: italic;">'+currentRuns[runIdx]['summary']+'</span><ul class="runCommentsList"></p>';
	for (var k=0; k<comments.length; k++){
		comments[k].comment=comments[k].comment.replace();
		childText=childText+'<li style="padding:5px 5px 5px 5px;white-space: pre-line"><b><span class="commentTime">'+moment.utc(Number(comments[k].time)).format('YYYY/MM/DD HH:mm:ss')+'</span> (<span class="commentAuthor">'+comments[k].author+'</span>):</b> <span class="commentButtons" style="float:right"><button class="button pill icon edit '+k+' '+runIdx+'"></button><button class="button pill icon trash danger '+k+' '+runIdx+'"></button></span><span class="commentComment" style="font-weight:normal;display:inline-block;width:100%;padding-left:10%;">'+comments[k].comment+'</span></li>';
	}
	childText=childText+'</ul>';
	if (active){
		var type="runCommentDateActive";
	}
	else{
		var type="runCommentDate";
	}
	$(".lightboxable").empty();
	$(".lightboxable").append('<h3 style="align:center;text-align:center">Run info -'+ runNumber +'</h3><div style="overflow:auto;height:400px">'+childText+'</div><hr style="width:25%"><h3 style="align:center;text-align:center">Insert/Edit info</h3><p>Date : <input class="'+type+' runCommentInput"></input></p><p>Author: <input class="runCommentAuthor runCommentInput"></input></p><p>Edit summary:<input class="runSummary runCommentInput" style="width:50%" value="'+currentRuns[runIdx]['summary']+'"></input></p><p>Insert comment: <textarea placeholder="Keep this input empty if you only want to edit your run summary" class="runComments" style="width:50%;height:150px"></textarea></p><p class="submitPar" style="text-align:center;align:center"></p>');
	$(".lightboxable").find('.'+type).flatpickr({
		enableTime: true,
		enableSeconds: true,
		time_24hr: true,
		dateFormat: 'd/m/Y H:i:S',
		minuteIncrement: 1,
		allowInput:true
	});
	$(".lightboxable").find('.runComments').alphanum({
		allow              : '_-/()',
		allowUpper         : true,
		//allowOtherCharSets : false,
		allowSpace         : true,
		allowNewline       : true
	});
	$(".lightboxable").find('.runCommentsList').find('.edit').click(function(){
		var commentIdx=Number($(this).prop('class').split(' ')[4]);
		var thisRunIdx=Number($(this).prop('class').split(' ')[5]);
		var time=$($($(this).parent()).parent()).find('.commentTime').html();
		var author=$($($(this).parent()).parent()).find('.commentAuthor').html();
		var comment=$($($(this).parent()).parent()).find('.commentComment').html();
		var nowDate=new Date();
		var theParent=$($($(this).parent()).parent())[0];
		$($($(this).parent()).parent()).find('.commentTime').empty();
		$($($(this).parent()).parent()).find('.commentTime').append('<input class="commentTimeInput"></input>');
		$($($(this).parent()).parent()).find('.commentTimeInput').flatpickr({
			enableTime: true,
			enableSeconds: true,
			time_24hr: true,
			dateFormat: 'd/m/Y H:i:S',
			minuteIncrement: 1,
			allowInput:true
		});
		$(theParent).find('.commentButtons').html('<button class="button pill icon approve"></button> <button class="button pill icon remove danger"></button>');
		$(theParent).find('.commentAuthor').empty();
		$(theParent).find('.commentAuthor').append('<input class="commentAuthorInput" value="'+author+'"></input>');
		$(theParent).find('.commentComment').empty();
		$(theParent).find('.commentComment').append('<textarea style="height:150px;width:50%" class="commentCommentInput">'+comment+'</textarea>');
		document.querySelector('.commentTimeInput')._flatpickr.setDate(moment.utc(time,'YYYY/MM/DD HH:mm:ss').valueOf()+nowDate.getTimezoneOffset()*1000*60);
		$(".lightboxable").find('.runCommentsList').find('button').unbind('click');
		$(".lightboxable").find('.runCommentsList').find('button').click(function(){
			setupComments(element,table,runNumber,active);
		});
		$(theParent).find('.approve').unbind('click');
		$(theParent).find('.approve').click(function(){
			var time=moment.utc($($($(this).parent()).parent()).find('.commentTimeInput').val(),'DD/MM/YYYY HH:mm:ss').valueOf();
			var author=$($($(this).parent()).parent()).find('.commentAuthorInput').val();
			var comment=$($($(this).parent()).parent()).find('.commentCommentInput').val();
			var theComment={'comment':comment ,'author':author,'time':time};
			var newDate=new Date();
			comments[commentIdx]=theComment;
			runEdit['comments']=JSON.stringify(comments);
			var insertData={
				'rows'  :  [{'run'  :  runEdit , 'action' : 'change'}],
				'date'  :  String(newDate.getTime()),
				'dbname':  dbname
			};
			$.ajax({
				url: '/runs/insertRun',
				type: 'POST',
				dataType: "json",
				contentType: "application/json; charset=UTF-8",
				data : JSON.stringify(insertData),
				'theIndex':thisRunIdx,
				success: function(returned){
					updateRuns(function(){
						currentRuns[runIdx]['comments']=JSON.stringify(comments);
						setupComments(element,table,runNumber,active);
					});
				},
				error: function(returned){
					alert('There was an error handling your request');
				}
			});
		});
		$(theParent).find('.remove').unbind('click');
		$(theParent).find('.remove').click(function(){
			setupComments(element,table,runNumber,active)
		});
	});
	$(".lightboxable").find('.runCommentsList').find('.trash').click(function(){
		var commentIdx=Number($(this).prop('class').split(' ')[5]);
		var thisRunIdx=Number($(this).prop('class').split(' ')[6]);
		r=confirm('Are you sure you want to delete this entry?');
		if(r){
			comments.splice(commentIdx,1);
			runEdit['comments']=JSON.stringify(comments);
			var newDate=new Date();
			var insertData={
				'rows'  :  [{'run'  :  runEdit , 'action' : 'change'}],
				'date'  :  String(newDate.getTime()),
				'dbname':  dbname
			};
			$.ajax({
				url: '/runs/insertRun',
				type: 'POST',
				dataType: "json",
				contentType: "application/json; charset=UTF-8",
				data : JSON.stringify(insertData),
				'theIndex':thisRunIdx,
				success: function(returned){
					updateRuns(function(){
						currentRuns[runIdx]['comments']=JSON.stringify(comments);
						setupComments(element,table,runNumber,active);
					});
				},
				error: function(returned){
					alert('There was an error handling your request');
				}
			});
		}
	});
	var nowDate=new Date();
	document.querySelector('.'+type)._flatpickr.setDate(moment.utc().valueOf()+nowDate.getTimezoneOffset()*1000*60);
	$(".lightboxable").find('.runCommentInput').on('input',function(){
		var foundEmpty=false;
		$(".lightboxable").find('.runCommentInput').each(function(){
			if($(this).val()=='' || $(this).val()=='null'){
				foundEmpty=true;
			}
		});
		if(foundEmpty){
			$(".lightboxable").find('.submitPar').empty();
			$(".lightboxable").find('.submitPar').append('<span style="background-color:#f2dede">Please fill in date, run summary and author inputs</span>');
		}
		else{
			$(".lightboxable").find('.submitPar').empty();
			$(".lightboxable").find('.submitPar').append('<button class="submitComment button pill" style="font-size:150%">Submit</button>');
			$(".lightboxable").find('.submitComment').click(function(){
				currentRuns[runIdx]['comments']=$(".lightboxable").find('.runComments').val();
				currentRuns[runIdx]['summary']=$(".lightboxable").find('.runSummary').val();
				var runCommentAuthor=$(".lightboxable").find('.runCommentAuthor').val();
				var runCommentDate=moment.utc($(".lightboxable").find('.'+type).val(),'DD/MM/YYYY HH:mm:ss').valueOf();
				var newDate=new Date();
				var insertData={
					'rows'  :  [{'run'  :  runEdit , 'action' : 'addComment','comment':currentRuns[runIdx]['comments'],'summary':currentRuns[runIdx]['summary'],'author':runCommentAuthor,'date':runCommentDate}],
					'date'  :  String(newDate.getTime()),
					'dbname':  dbname
				};
				$.ajax({
					url: '/runs/insertRun',
					type: 'POST',
					dataType: "json",
					contentType: "application/json; charset=UTF-8",
					data : JSON.stringify(insertData),
					success: function(returned){
						updateRuns(function(){
							if(currentRuns[runIdx]['comments']!='' && currentRuns[runIdx]['comments']!=null){
								comments.push({'time':runCommentDate,'author':runCommentAuthor,'comment':currentRuns[runIdx]['comments']});
							}
							currentRuns[runIdx]['comments']=JSON.stringify(comments);
							setupComments(element,table,runNumber,active);
						});
					},
					error: function(returned){
						alert('There was a problem inserting your comment/summary, please try again' + JSON.stringify(returned));
					}
				});
			});
		}
		$.colorbox.resize();
	});
	$($(".lightboxable").find('.runCommentInput')[0]).trigger('input');
	$.colorbox({
		inline:true,
		href:$(".lightboxable"),
		onOpen:function(){
			$(".lightboxable-outer").show();
		},
		onCleanup:function(){
			$(".lightboxable-outer").hide();
			globalUpdateOngoing=false;
		},
		width:"75%",
		maxWidth: "1000px",
		closeButton	:false
	});
}

function setupEditButton(element,table,runNumber,active){
	if(currentType=="1" || currentType=="3"){
		runIdx=Number(element.attr('class').split(' ')[1]);
		var runEdit=DAQBroToRemoteRun(runlistInfoObj, currentRuns[runIdx]);
		var row=$($(element.parent()).parent());
		var runlistRow=table.row(row);
		var oldData=runlistRow.data();
		var newDataLine={};
		var formatStart='';
		var formatEnd='';
		if(active){
			var type='activeTimeRunInsert';
		}
		else{
			var type='timeRunInsert';
		}
		$('.lightboxable').empty();
		$('.lightboxable').append('<h3 style="margin:auto;width:100%;text-align:center">Edit Run - '+runNumber+'</h3><hr style="width:25%"><div class="times"><p style="font-size:125%;margin:auto;width:100%;text-align:center">Dates</p></div><hr style="width:25%"><div class="parameters"><p style="font-size:125%;margin:auto;width:100%;text-align:center">Parameters</p></div><hr style="width:25%"><div class="mandatory"><p style="font-size:125%;margin:auto;width:100%;text-align:center">Mandatory parameters</p><div class="identifier"><p style="font-size:110%">Unique Identifier</p></div><div class="other"><p style="font-size:110%">Other parameters</p></div></div><div class="buttons" style="margin:auto;width:100%;text-align:center;align:center"><button class="cancelEdit button pill icon remove danger" style="font-size:125%">Cancel</button></div><div style="color:#a94442;background-color:#f2dede" class="insertErrorDiv"></div>');
		var runSep=currentRuns[runIdx]['run'].split('.');
		var runSepInputted=0;
		for (var i=0; i<runlistInfoObj.runlistRemarks.cols.length; i++){
			var col=runlistInfoObj.runlistRemarks.cols[i];
			if(col.type==0){
				var textPar='';
				if(currentRuns[runIdx][col.name]){
					var textPar=currentRuns[runIdx][col.name];
				}
				if(col.parType=="0"){
					$('.lightboxable').find('.parameters').append('<p>'+col.name+' : <input type="number" step="0.000001" class="rowEditInput '+col.name+'" value="'+textPar+'"></input> ('+col.parUnits+')</p>');
				}
				else{
					$('.lightboxable').find('.parameters').append('<p>'+col.name+' : <input type="text" class="rowEditInput '+col.name+'" value="'+textPar+'"></input></p>');
				}
				//newDataLine[col.name]='<input type="text" class="rowEditInput" value="'+currentRuns[runIdx][col.name]+'"></input>';
			}
			else if(col.type==4){
				var insideTrack='';
				for (var j=0; j<col.optionValues.length; j++){
					insideTrack=insideTrack+'<option value="'+col.optionValues[j]+'">'+col.optionValues[j]+'</option>';
				}
				var textPar='';
				if(currentRuns[runIdx][col.name]){
					var textPar=currentRuns[runIdx][col.name];
				}
				$('.lightboxable').find('.parameters').append('<p>'+col.name+' : <select class="rowEditInput '+col.name.split(' ').join('*')+'" value="'+textPar+'"><option disabled>---SELECT ONE---</option>'+insideTrack+'</select> </p>');
				$('.lightboxable').find('.parameters').find('.'+col.name.split(' ').join('\\*')).val(textPar);
			}
			else if(col.type==3){
				$('.lightboxable').find('.mandatory').find('.identifier').append('<p>'+col.name+' : <input type="number" min="1" step="1" class="rowEditInput run" value="'+runSep[runSepInputted]+'"></input></p>');
				runSepInputted=runSepInputted+1;
			}
		}
		var nowDate=new Date();
		$('.lightboxable').find('.times').append('<p>Start : <input type="text" class="timeStart start" value="'+currentRuns[runIdx]['start']+'"></input></p>');
		$('.lightboxable').find('.timeStart').flatpickr({
			enableTime: true,
			enableSeconds: true,
			time_24hr: true,
			dateFormat: 'd/m/Y H:i:S',
			minuteIncrement: 1,
			allowInput:true
		});
		$('.lightboxable').find('.times').append('<p>End : <input type="text" class="timeEnd end" value="'+currentRuns[runIdx]['end']+'"></input></p>');
		$('.lightboxable').find('.timeEnd').flatpickr({
			enableTime: true,
			enableSeconds: true,
			time_24hr: true,
			dateFormat: 'd/m/Y H:i:S',
			minuteIncrement: 1,
			allowInput:true
		});
		var nowDate=new Date();
		document.querySelector('.timeEnd')._flatpickr.setDate(Number(currentRuns[runIdx]['end'])+nowDate.getTimezoneOffset()*1000*60);
		document.querySelector('.timeStart')._flatpickr.setDate(Number(currentRuns[runIdx]['start'])+nowDate.getTimezoneOffset()*1000*60);
		
		$('.lightboxable').find('input').on('input',function(){
			$('.lightboxable').find('.errorMandatory').remove();
			$('.lightboxable').find('.approveEdit').remove();
			var foundEmpty=false;
			var foundDifferent=false;
			var timeEmpty=false;
			var timeDifferent=false;
			var identifier=[];
			var repeatOtherRun=false;
			var thisFirstClass=$(this).prop('class');
			$('.lightboxable').find('.mandatory').find('input').each(function(){
				var thisClass=$(this).prop('class').split(' ');
				var colName=thisClass.slice(1,thisClass.length).join(' ');
				if(colName=='run'){
					identifier.push(Number($(this).val()));
				}
				else{
					if(currentRuns[runIdx][colName]!=$(this).val()){
						foundDifferent=true;
					}
				}
				if($(this).val()=='' || $(this).val()==null){
					foundEmpty=true;
				}
			});
			if(identifier.join('.')!=currentRuns[runIdx]['run']){
				foundDifferent=true;
			}
			for (var i=0; i<currentRuns.length; i++){
				if(i!=runIdx){
					if(currentRuns[i].run==identifier.join('.')){
						repeatOtherRun=true;
					}
				}
			}
			$('.lightboxable').find('.parameters').find('input').each(function(){
				if(thisFirstClass==$(this).prop('class')){
					foundDifferent=true;
				}
			});
			$('.lightboxable').find('.times').find('input').each(function(){
				var timeStr=$(this).val();
				var timeNumber=moment.utc(timeStr,'D/M/YYYY H:m:s').valueOf();
				var timeClass=$(this).prop('class');
				if(timeClass.indexOf('timeStart')>=0){
					if(timeNumber!=currentRuns[runIdx]['start']){
						foundDifferent=true;
					}
				}
				else if(timeClass.indexOf('timeEnd')>=0){
					if(timeNumber!=currentRuns[runIdx]['end']){
						foundDifferent=true;
					}
				}
				if($(this).val()==''){
					timeEmpty=true;
				}
			});
			if(repeatOtherRun){
				$('.lightboxable').find('.identifier').append('<div style="background-color:#f2dede" class="errorMandatory">This run already exists!</div>');
			}
			else{
				if(foundEmpty || timeEmpty){
					$('.lightboxable').find('.buttons').append('<div style="background-color:#f2dede" class="errorMandatory">Please fill in ALL mandatory parameters</div>');
				}
				else{
					if(foundDifferent){
						$('.lightboxable').find('.buttons').append('<button class="approveEdit button pill icon approve" style="font-size:125%">Submit</button>');
					}
					var newRun={};
					var unique=[];
					$('.lightboxable').find('.approveEdit').click(function(){
						//approveEdit(runlistRow,runIdx);
						$('.lightboxable').find('.times').find('input').each(function(){
							var thisClass=$(this).prop('class');
							if(thisClass.indexOf('timeStart')>=0){
								newRun['start']=moment.utc($(this).val(),'D/M/YYYY H:m:s').valueOf();
							}
							else if(thisClass.indexOf('timeEnd')>=0){
								newRun['end']=moment.utc($(this).val(),'D/M/YYYY H:m:s').valueOf();
							}
						});
						$('.lightboxable').find('.parameters').find('input, select').each(function(){
							var thisClass=$(this).prop('class');
							var thisClass=$(this).prop('class').split(' ');
							var colName=thisClass.slice(1,thisClass.length).join(' ').split('*').join(' ');
							newRun[colName]=$(this).val();
						});
						$('.lightboxable').find('.mandatory').find('input, select').each(function(){
							var thisClass=$(this).prop('class');
							var thisClass=$(this).prop('class').split(' ');
							var colName=thisClass.slice(1,thisClass.length).join(' ').split('*').join(' ');
							if(colName!='run'){
								newRun[colName]=$(this).val();
							}
							else{
								if(Number($(this).val())<10){
									var toPush='0'+Number($(this).val());
								}
								else{
									var toPush=$(this).val();
								}
								unique.push(toPush);
							}
						});
						runIdx=Number(element.attr('class').split(' ')[1]);
						newRun['oldRun']=currentRuns[runIdx]['run'];
						newRun['run']=unique.join('.');
						newRun['comments']=currentRuns[runIdx]['comments'];
						newRun['summary']=currentRuns[runIdx]['summary'];
						var newDate=new Date();
						if(active){
							var action='addActive';
						}
						else{
							var action='add';
						}
						var insertData={
							'rows'  :  [{'run'  :  newRun , 'action' : 'change'}],
							'date'  :  String(newDate.getTime()),
							'dbname':  dbname
						};
						$.ajax({
							url: '/runs/insertRun',
							type: 'POST',
							dataType: "json",
							contentType: "application/json; charset=UTF-8",
							data : JSON.stringify(insertData),
							success: function(returned){
								$(".insertErrorDiv").empty();
								$.colorbox.close();
								updateRuns();
							},
							error: function(returned){
								alert("There was an error processing your request");
							}
						});
					});
				}
			}
			$.colorbox.resize();
		});
		$('.lightboxable').find('.mandatory').find('input').trigger('input');
		$($(runlistRow.node()).find('.rowEditInput')[0]).focus();
		$('.lightboxable').find('.cancelEdit').click(function(){
			$.colorbox.close();
		});
		$.colorbox({
			inline:true,
			href:$(".lightboxable"),
			onOpen:function(){
				$(".lightboxable-outer").show();
			},
			onCleanup:function(){
				$(".lightboxable-outer").hide();
				globalUpdateOngoing=false;
			},
			width:"75%",
			maxWidth: "1000px",
			closeButton	:false
		});
	}
}

function approveEdit(runlistRow, runIdx, table){
	var rowData=runlistRow.data();
	var foundEndTime=false;
	var newRowData={};
	var foundRun=false;
	table.cells($($(runlistRow.node()).find(':input').parent())).every( function () {
		var data = this.data();
		var thisIdx=this.index();
		var thisPar=runTable.column(thisIdx['column']).dataSrc().split(' ').join('*');
		console.log(thisPar);
		var currentKeys=Object.keys(currentRuns[runIdx]);
		for (var i=0; i<currentKeys.length; i++){
		 	var col=runlistInfoObj.runlistRemarks.cols[i];
			if(thisPar==currentKeys[i] && thisPar!='alter'){
				if(thisPar=='start' || thisPar=='end'){
					//var nodeDate=(($(this.node()).find(':input').val(),);
					newRowData[thisPar]=String($(this.node()).find(':input').data('daterangepicker').startDate.valueOf());
				}
				else{
					newRowData[thisPar]=$(this.node()).find(':input').val();
				}
			}
		}
	});
	newRowData['comments']=currentRuns[runIdx]['comments'];
	newRowData['summary']=currentRuns[runIdx]['summary'];
	var runToInsert=DAQBroToRemoteRun(runlistInfoObj, newRowData);
	var runToDelete=DAQBroToRemoteRun(runlistInfoObj, currentRuns[runIdx]);
	newRowData['alter']='';
	var newDate=new Date();
	var insertData={
		'rows'  :  [{'run'  :  runToDelete , 'action' : 'delete'},{'run'  :  runToInsert , 'action' : 'add'}],
		'date'  :  String(newDate.getTime()),
		'dbname':  dbname
	};
	$.ajax({
		url: 'insertRuns.php',
		type: 'POST',
		dataType: "json",
		data : insertData ,
		success: function(returned){
			$("#errorDiv").empty();
			$(".expandErrors").empty();
			var errorsFound=false;
			for (var i=0; i<returned.errorRows.length; i++){
				if(returned.errorRows[i]==1){
					if(!errorsFound){
						$("#errorDiv").append('Some changes could not be inserted, <a class="expandErrorsShow">click here</a> for an explanation.');
						errorsFound=true;
					}
					$(".expandErrors").append('<p>'+i+'. Row:'+JSON.stringify(returned.runs[i])+' | Error: '+returned.errorStrRows[i]+' | MySQL error: '+returned.errorMsgRows[i]+'</p>');
				}
			}
			if(errorsFound){
				insertData={
					'rows'  :  [{'run'  :  runToDelete , 'action' : 'add'}],
					'date'  :  String(newDate.getTime()),
					'dbname':  dbname
				};
				$.ajax({
					url: 'insertRuns.php',
					type: 'POST',
					dataType: "json",
					data : insertData,
					success: function(){
						updateRuns();
					}
				});
			}
			else{
				delete newRowData['comments'];
				delete newRowData['summary'];
				runlistRow.child().remove();
				runlistRow.data(newRowData);
				
				updateRuns();
			}
			$(".expandErrorsShow").click(function(){
				$.colorbox({
					inline:true,
					href:$(".expandErrors"),
					onOpen:function(){
						$(".expandErrors-outer").show();
					},
					onCleanup:function(){
						$(".expandErrors-outer").hide();
						updateRuns();
					},
					width:"75%",
					maxWidth: "1000px",
					closeButton	:false
				});
			});
		},
		error: function(returned){
			console.log('error');
			console.log(returned);
		}
	});
}

function setButtons(){
	if(currentType=="1" || currentType=="3"){
		var foundActive=false;
		var activeIdx=0;
		$("#activeRun").find('.buttons').empty();
		for (var i=0; i<currentRuns.length; i++){
			if(Number(currentRuns[i].active)==1){
				foundActive=true;
				activeIdx=i;
				break;
			}
		}
		if(foundActive){
			$("#activeRun").find('.buttons').append('<button style="font-size:90%" class="endRun button pill huge icon danger remove">End Run</button>');
			$("#activeRun").find('.endRun').click(function(){
				endRun();
			});
		}
		else{
			$("#activeRun").find('.buttons').append('<button style="font-size:90%" class="newRun button pill huge icon add">New Run</button>');
			$("#activeRun").find('.newRun').click(function(){
				newRun();
			});
		}
	}
}

function newRun(){
	globalUpdateOngoing=true;
	$(".lightboxable").empty();
	$(".lightboxable").append('<h3>Create a new Run</h3><div class="runPars"><p style="font-weight:bold;">Run Parameters</p></div><div class="runUnique"><p style="font-weight:bold;">Unique Identifier (mandatory)</p></div><div class="errorDiv" style="color:#a94442;background-color:#f2dede"></div>');
	if(currentRuns.length>0){
		var lastRun=currentRuns[currentRuns.length-1];
		var uniqueArray=lastRun['run'].split('.');
	}
	else{
		var lastRun={};
		var uniqueArray=[];
	}
	var uniqueArrayIdx=0;
	var foundEndTime=false
	for (var i=0; i<runlistInfoObj.runlistRemarks.cols.length; i++){
		var col=runlistInfoObj.runlistRemarks.cols[i];
		if(col.type==0){
			var textPar='';
			console.log(lastRun[col.name]);
			console.log(!((typeof lastRun[col.name])==="unefined"));
			if(lastRun[col.name] || Object.keys(lastRun).length != 0){
				textPar=lastRun[col.name];
			}
			if(col.parType=="0"){
				$('.lightboxable').find('.runPars').append('<p>'+col.name+' : <input type="number" step="0.000001" class="'+col.name.split(' ').join('*')+'" value="'+textPar+'"></input> ('+col.parUnits+')</p>');
			}
			else{
				$('.lightboxable').find('.runPars').append('<p>'+col.name+' : <input type="text" class="'+col.name.split(' ').join('*')+'" value="'+textPar+'"></input></p>');
			}
		}
		else if(col.type==4){
			var insideTrack='';
			for (var j=0; j<col.optionValues.length; j++){
				insideTrack=insideTrack+'<option value="'+col.optionValues[j]+'">'+col.optionValues[j]+'</option>';
			}
			var textPar='';
			if(lastRun[col.name] || !((typeof lastRun[col.name])==="unefined")){
				textPar=lastRun[col.name];
			}
			$('.lightboxable').find('.runPars').append('<p>'+col.name+' : <select class="'+col.name.split(' ').join('*')+'" value="'+textPar+'"><option selected disabled>---SELECT ONE---</option>'+insideTrack+'</select> </p>');
			$('.lightboxable').find('.runPars').find('.'+col.name.split(' ').join('\\*')).val(textPar);
		}
		else if(col.type==3){
			var uniqueVal=uniqueArray[uniqueArrayIdx];
			$(".lightboxable").find('.runUnique').append('   ' + col.name+' : <input type="number" class="'+col.name+' mandatory" placeholder="last Value: '+uniqueVal+'"></input> |');
			uniqueArrayIdx=uniqueArrayIdx+1;
		}
		else if(col.type==2){
			foundEndTime=true;
		}
	}
	$(".lightboxable").find('.runUnique').append('<p>Summary <input class="summary"></input></p>');
	$(".lightboxable").find('.mandatory').on('input',function(){
		$(".lightboxable").find('.donePar').remove();
		var emptyInput=false;
		$(".lightboxable").find('.emptyError').remove();
		$(".lightboxable").find('.mandatory').each(function(){
			if($(this).val()==''){
				emptyInput=true;
				$(this).after('<span style="color:#a94442;background-color:#f2dede" class="emptyError">This is empty</span>');
			}
		});
		if(!emptyInput){
			var uniqueNew=[];
			var alreadyExists=false;
			$(".lightboxable").find('.mandatory').each(function(){
				if(Number($(this).val())<10){
					var toInput='0'+Number($(this).val());
				}
				else{
					var toInput=$(this).val();
				}
				uniqueNew.push(toInput);
			});
			for (var i=0; i<currentRuns.length; i++){
				if(uniqueNew.join('.')==currentRuns[i]['run']){
					alreadyExists=true;
					break;
				}
			}
			$(".lightboxable").find('.errorDiv').empty();
			if(alreadyExists){
				$(".lightboxable").find('.errorDiv').append('Run \''+uniqueNew.join('.')+'\' already exists!');
			}
			else{
				$(".lightboxable").find('.errorDiv').before('<p class="donePar" align="right"><button class="done" value="Start Run">Start Run</button></p>');
				$(".lightboxable").find('.done').click(function(){
					console.log("ASDIOAJSDOIJSDASD");
					if(!$(".lightboxable").find('.summary').val()){
						$(".lightboxable").find('.summaryError').remove()
						$(".lightboxable").find('.summary').after('<span class="summaryError" style="background-color:#f2dede;color:#a94442"> A summary is required </span>');
					}
					else{
						var inputRun={};
						inputRun['run']=uniqueNew.join('.');
						$(".lightboxable").find('.runPars').find(':input').each(function(){
							var thePar=$(this).attr('class').split(' ')[0];
							inputRun[thePar.split('*').join(' ')]=$(this).val();
						});
						var newDate=new Date();
						inputRun['start']=String(newDate.getTime());
						inputRun['summary']=$(".lightboxable").find('.runUnique').find('.summary').val();
						if(foundEndTime){
							inputRun['end']=String(newDate.getTime());
						}
						if(Number(runlistInfoObj.runlistType)>0){
							inputRun=DAQBroToRemoteRun(runlistInfoObj, inputRun);
						}
						var insertData={
							'rows'  :  [{'run'  :  inputRun , 'action' : 'addActive'}],
							'date'  :  String(newDate.getTime()),
							'dbname':  dbname
						};
						$.ajax({
							url: '/runs/insertRun',
							type: 'POST',
							dataType: "json",
							contentType: "application/json; charset=UTF-8",
							data : JSON.stringify(insertData),
							success: function(returned){
								$(".errorDiv").empty();
								globalUpdateOngoing=false;
								onGoingCreation=false;
								$.colorbox.close();
								updateRuns();
							},
							error: function(returned){
								alert("There was an error handling your request");
							}
						});
					}
				});
			}
		}
		$.colorbox.resize();
	});
	
	$.colorbox({
		inline:true,
		href:$(".lightboxable"),
		onOpen:function(){
			$(".lightboxable-outer").show();
		},
		onCleanup:function(){
			$(".lightboxable-outer").hide();
			globalUpdateOngoing=false;
		},
		width:"75%",
		maxWidth: "1000px",
		closeButton	:false
	});
}

function endRun(){
	globalUpdateOngoing=true;
	$(".lightboxable").empty();
	$(".lightboxable").append('<h3>End Run Summary</h3><div class="runPars"><p style="font-weight:bold;">Run Parameters</p></div><div class="runUnique"><p style="font-weight:bold;">Unique Identifier (mandatory)</p></div><div class="errorDiv" style="color:#a94442;background-color:#f2dede"></div>');
	var lastRun={}
	for (var i=0; i<currentRuns.length; i++){
		if(currentRuns[i]['active']=='1'){
			lastRun=currentRuns[i];
		}
	}
	var uniqueArray=lastRun['run'].split('.');
	var uniqueArrayIdx=0;
	var foundEndTime=false
	for (var i=0; i<runlistInfoObj.runlistRemarks.cols.length; i++){
		var col=runlistInfoObj.runlistRemarks.cols[i];
		if(col.type==0){
			//$(".lightboxable").find('.runPars').append('<p>'+col.name+' : <input type="text" class="'+col.name.split(' ').join('|')+'" value="'+lastRun[col.name]+'"></input></p>');
			if(col.parType=="0"){
				$('.lightboxable').find('.runPars').append('<p>'+col.name+' : <input type="number" step="0.000001" class="'+col.name.split(' ').join('*')+'" value="'+lastRun[col.name]+'"></input> ('+col.parUnits+')</p>');
			}
			else{
				$('.lightboxable').find('.runPars').append('<p>'+col.name+' : <input type="text" class="'+col.name.split(' ').join('*')+'" value="'+lastRun[col.name]+'"></input></p>');
			}
		}
		else if(col.type==4){
			var insideTrack='';
			for (var j=0; j<col.optionValues.length; j++){
				insideTrack=insideTrack+'<option value="'+col.optionValues[j]+'">'+col.optionValues[j]+'</option>';
			}
			if(lastRun[col.name]){
				var textPar=lastRun[col.name];
			}
			else{
				var textPar=null;
			}
			$('.lightboxable').find('.runPars').append('<p>'+col.name+' : <select class="'+col.name.split(' ').join('*')+'" value="'+textPar+'"><option selected disabled>---SELECT ONE---</option>'+insideTrack+'</select> </p>');
			$('.lightboxable').find('.runPars').find('.'+col.name.split(' ').join('\\*')).val(textPar);
		}
		else if(col.type==3){
			var uniqueVal=uniqueArray[uniqueArrayIdx];
			$(".lightboxable").find('.runUnique').append('   ' + col.name+' : <input type="number" class="'+col.name+' mandatory" value="'+lastRun[col.name]+'" placeholder="last Value: '+uniqueVal+'"></input> |');
			uniqueArrayIdx=uniqueArrayIdx+1;
		}
		else if(col.type==2){
			foundEndTime=true;
		}
	}
	$(".lightboxable").find('.mandatory').prop('disabled',true);
	$(".lightboxable").find('.errorDiv').before('<p class="donePar" align="right"><button class="done button huge icon danger approve" value="Start Run">End Run</button></p>');
	$(".lightboxable").find('.done').click(function(){
		var inputRun={};
		inputRun['run']=lastRun['run'];
		inputRun['comments']=lastRun['comments'];
		inputRun['summary']=lastRun['summary'];
		$(".lightboxable").find('.runPars').find(':input').each(function(){
			var thePar=$(this).attr('class').split(' ')[0];
			inputRun[thePar.split('*').join(' ')]=$(this).val();
		});
		var newDate=new Date();
		inputRun['start']=lastRun['start'];
		for (var i=0; i<runlistInfoObj.runlistRemarks.cols.length; i++){
			if(col.type==2){
				foundEndTime=true;
			}
		}
		if(foundEndTime){
			inputRun['end']=String(newDate.getTime());
		}
		var insertData={
			'rows'  :  [{'run'  :  inputRun , 'action' : 'inactive'}],
			'date'  :  String(newDate.getTime()),
			'dbname':  dbname
		};
		$.ajax({
			url: '/runs/insertRun',
			type: 'POST',
			dataType: "json",
			contentType: "application/json; charset=UTF-8",
			data : JSON.stringify(insertData),
			success: function(returned){
				$(".errorDiv").empty();
				globalUpdateOngoing=false;
				onGoingCreation=false;
				$.colorbox.close(true);
				updateRuns();
			},
			error: function(returned){
				alert('There was an error handling your request');
			}
		});
	});
	
	$.colorbox({
		inline:true,
		href:$(".lightboxable"),
		onOpen:function(){
			$(".lightboxable-outer").show();
		},
		onCleanup:function(){
			$(".lightboxable-outer").hide();
			globalUpdateOngoing=false;
		},
		width:"75%",
		maxWidth: "1000px",
		closeButton	:false
	});
	
}

function cancelEdit(row,runIdx,table){
	var newDataLine={};
	var foundEndTime=false;
	for (var i=0; i<runlistInfoObj.runlistRemarks.cols.length; i++){
		var col=runlistInfoObj.runlistRemarks.cols[i];
		if(col.type==0){
			newDataLine[col.name]=currentRuns[runIdx][col.name];
		}
		else if(col.type==2){
			foundEndTime=true;
		}
	}
	var startDate=new Date(Number(currentRuns[runIdx]['start']));
	//newDataLine['start']=startDate.toUTCString();
	newDataLine['start']=moment.utc(startDate.getTime()).format('YYYY/MM/DD HH:mm:ss');
	newDataLine['run']=currentRuns[runIdx]['run'];
	newDataLine['alter']='<p><button class="comentsAdd '+runIdx+' button pill huge icon comment"></button></button></p><p><button class="editRun '+runIdx+' button pill huge icon edit"></button> <button class="delete '+runIdx+' button pill huge icon danger remove"></button></p>';
	if(foundEndTime){
		var endDate=new Date(Number(currentRuns[runIdx]['end']));
		newDataLine['end']=moment.utc(endDate.getTime()).format('YYYY/MM/DD HH:mm:ss');
	}
	row.data(newDataLine).draw();
	/*$(row.node()).find('.editRun').click(function(){
		var element=$(this);
		setupEditButton(element);
	});
	$(row.node()).find('.delete').click(function(){
		var element=$(this);
		setupDeleteButton(element);
	});*/
	if(currentType=="1" || currentType=="3"){
		$(row.node()).find('.editRun').click(function(){
			var element=$(this);
			setupEditButton(element);
		});
		$(row.node()).find('.delete').click(function(){
			var element=$(this);
			setupDeleteButton(element);
		});
	}
	else{
		$(row.node()).find('.editRun').prop('disabled',true);
		$(row.node()).find('.delete').prop('disabled',true);
	}
	$(row.node()).find('.commentsAdd').click(function(){
		var element=$(this);
		setupComments(element,table,false);
	});
	//runTable.row(row.index()).show().draw(false);
	row.child().remove();
}

var numberEls=0;

/*$(document).ready( function() {

	$("#cssmenu").hiraku({
		btn: ".homeIcon",
		fixedHeader: ".headerMenu",
		direction: "left",
		breakpoint: 3000
	});
	
	$(".theSettings").hiraku({
		btn: ".hamburger",
		fixedHeader: ".headerMenu",
		direction: "right",
		breakpoint: 3000
	});

	/*$('#cssmenu').slimmenu({
		resizeWidth: '850',
		collapserTitle: '<a class="homeIcon" style="cursor:pointer;">DAQBroker</a>',
		animSpeed: 'medium',
		easingEffect: null,
		indentChildren: false,
		childrenIndenter: '&nbsp;'
	});
});*/

</script>

</body>
</html>
